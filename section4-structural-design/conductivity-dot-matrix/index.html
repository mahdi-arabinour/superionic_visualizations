<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Dot Matrix (D3): Conductivity vs Strategy</title>
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; }
    .chart-wrap { max-width: 1100px; }
    svg { width: 100%; height: auto; }
    .axis path, .axis line { stroke: #999; }
    .grid line { stroke: #eee; }
    .legend-title { font-weight: 600; }
    .tooltip {
      position: absolute; pointer-events: none;
      background: rgba(0,0,0,.8); color: #fff;
      padding: 8px 10px; border-radius: 6px;
      font-size: 12px; line-height: 1.3;
    }
  </style>
</head>
<body>
  <h1>Conductivity σ (S/cm) vs Doping / and or GB Strategy</h1>
  <div class="chart-wrap">
    <svg id="dot-matrix" viewBox="0 0 1100 620" preserveAspectRatio="xMinYMin"></svg>
  </div>
  <div id="tooltip" class="tooltip" style="opacity:0"></div>

  <script>
    const COL_SIGMA   = "Conductivity σ (S/cm)";
    const COL_STRUCT  = "Structure Group";
    const COL_DOPANT  = "Doping / and or GB Strategy";

    const structureColors = {
      "Others": "#9e9e9e",
      "Polymeric": "#ff7043",
      "Argyrodite": "#ab47bc",
      "Halide": "#26a69a",
      "Amorphous": "#f6bf26",
      "NASICON": "#66bb6a",
      "Anti-perovskite": "#0d47a1",
      "Spinel": "#8d6e63"
    };

    const svg = d3.select("#dot-matrix");
    const width = 1100, height = 620;
    const margin = { top: 20, right: 280, bottom: 120, left: 90 };
    const innerW = width - margin.left - margin.right;
    const innerH = height - margin.top - margin.bottom;
    const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);
    const tip = d3.select("#tooltip");

    // Load CSV
    d3.csv("data.csv", d3.autoType).then(data => {
      const clean = data.filter(d =>
        isFinite(+d[COL_SIGMA]) && d[COL_STRUCT] && d[COL_DOPANT]
      );

      const grouped = d3.rollups(
        clean,
        v => ({ count: v.length, avg_sigma: d3.mean(v, d => +d[COL_SIGMA]) }),
        d => d[COL_DOPANT],
        d => d[COL_STRUCT]
      );

      const points = [];
      for (const [strategy, byStruct] of grouped) {
        for (const [structure, stats] of byStruct) {
          points.push({ strategy, structure, count: stats.count, avg_sigma: stats.avg_sigma });
        }
      }

      // Scales
      const xDomain = Array.from(new Set(clean.map(d => d[COL_DOPANT]))).sort(d3.ascending);
      const xScale = d3.scaleBand().domain(xDomain).range([0, innerW]).padding(0.35);
      const sigmaVals = clean.map(d => +d[COL_SIGMA]).filter(v => v > 0);
      const yScale = d3.scaleLog().domain(d3.extent(sigmaVals)).range([innerH, 0]).nice();
      const colorScale = d3.scaleOrdinal()
        .domain(Object.keys(structureColors))
        .range(Object.values(structureColors));
      const rScale = d3.scaleSqrt()
        .domain([1, d3.max(points, d => d.count) || 1])
        .range([5, 28]);

      const jitter = d3.randomNormal.source(d3.randomLcg(42))(0, 0.9);
      const xCenter = d => xScale(d.strategy) + xScale.bandwidth() / 2 + (xScale.bandwidth() * 0.1) * jitter();

      // Axes
      g.append("g")
        .attr("class", "grid")
        .call(d3.axisLeft(yScale).tickSize(-innerW).tickFormat("").ticks(8));
      g.append("g").attr("class", "axis")
        .attr("transform", `translate(0,${innerH})`)
        .call(d3.axisBottom(xScale))
        .selectAll("text")
        .style("text-anchor", "end")
        .attr("dx", "-0.5em")
        .attr("dy", "0.15em")
        .attr("transform", "rotate(-35)");
      g.append("g").attr("class", "axis").call(d3.axisLeft(yScale).ticks(8, d3.format(".1e")));
      g.append("text").attr("x", -margin.left + 10).attr("y", -6)
        .attr("font-weight", 600).text("Conductivity σ (S/cm)");
      g.append("text").attr("x", innerW / 2).attr("y", innerH + 80)
        .attr("text-anchor", "middle").attr("font-weight", 600)
        .text("Doping / and or GB Strategy");

      const fmt = d3.format(".3e");
      function showTip(event, d) {
        tip.style("opacity", 1)
          .html(`<div><strong>Structure:</strong> ${d.structure}</div>
                 <div><strong>Strategy:</strong> ${d.strategy}</div>
                 <div><strong>Count:</strong> ${d.count}</div>
                 <div><strong>Avg σ:</strong> ${fmt(d.avg_sigma)}</div>`)
          .style("left", (event.pageX + 12) + "px")
          .style("top", (event.pageY + 12) + "px");
      }
      function hideTip() { tip.style("opacity", 0); }

      // Dots
      g.selectAll("circle.dot")
        .data(points)
        .join("circle")
        .attr("class", "dot")
        .attr("cx", d => xCenter(d))
        .attr("cy", d => yScale(d.avg_sigma))
        .attr("r", d => rScale(d.count))
        .attr("fill", d => colorScale(d.structure))
        .attr("fill-opacity", 0.9)
        .attr("stroke", "rgba(0,0,0,.35)")
        .on("mousemove", showTip)
        .on("mouseleave", hideTip);

      // Color legend
      const legendX = innerW + 30;
      let lgY = 10;
      g.append("text").attr("x", legendX).attr("y", lgY)
        .attr("class", "legend-title").text("Structure Group");
      lgY += 14;
      const colorLegend = g.append("g").attr("transform", `translate(${legendX}, ${lgY})`);
      Object.entries(structureColors).forEach(([key, color], i) => {
        const item = colorLegend.append("g").attr("transform", `translate(0, ${i * 20})`);
        item.append("circle").attr("r", 6).attr("cx", 6).attr("cy", 6)
          .attr("fill", color).attr("stroke", "rgba(0,0,0,.35)");
        item.append("text").attr("x", 18).attr("y", 10).text(key);
      });

      // Size legend
      const sizeLegendY = lgY + Object.keys(structureColors).length * 20 + 24;
      const sizeLegend = g.append("g").attr("transform", `translate(${legendX}, ${sizeLegendY})`);
      sizeLegend.append("text").attr("class", "legend-title").text("Sample Count");
      const maxCount = d3.max(points, d => d.count);
      const ticks = [1, Math.ceil(maxCount / 2), maxCount];
      let cursorX = 0;
      ticks.forEach(v => {
        const r = rScale(v);
        const group = sizeLegend.append("g").attr("transform", `translate(${cursorX + r}, 28)`);
        group.append("circle").attr("r", r).attr("fill", "#ccc").attr("fill-opacity", 0.5).attr("stroke", "#666");
        group.append("text").attr("x", r + 8).attr("y", 4).text(v);
        cursorX += r * 2 + 42;
      });
    });
  </script>
</body>
</html>

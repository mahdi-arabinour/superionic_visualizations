<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Heatmap — SSE × Cathode (Cycle Life)</title>
<script src="https://d3js.org/d3.v7.min.js"></script>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #ffffff;
    color: #111;
    margin: 32px;
  }
  h2 { color: #000; }
  p { color: #333; }
  svg {
    background: #ffffff;
    border: 1px solid #ccc;
    border-radius: 8px;
  }
  .axis text { font-size: 11px; fill: #111; }
  .axis .domain, .axis line { stroke: #aaa; }
  .cell { stroke: #eee; stroke-width: 0.6; }
  .tooltip {
    position: absolute;
    background: #fff;
    border: 1px solid #ccc;
    border-radius: 6px;
    padding: 6px 8px;
    font-size: 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,.15);
    pointer-events: none;
  }
  .legendTitle { font-size: 12px; fill: #111; }
  .status { font-size: 12px; color: #333; margin-top: 8px; }
</style>
</head>
<body>

<h2>Heatmap — SSE × Cathode (Color = Cycle Life)</h2>
<p style="margin-top:-6px;">y = <b>Formula (SSE)</b>, x = <b>Cathode</b>, color = <b>Cycle Life</b></p>

<svg id="chart" width="980" height="700"></svg>
<div class="status" id="status">Loading data...</div>
<div class="tooltip" id="tt" style="visibility:hidden"></div>

<script>
const CSV_FILE = "data.csv";

const margin = { top: 80, right: 20, bottom: 140, left: 220 },
      outerW = 980, outerH = 700,
      width  = outerW - margin.left - margin.right,
      height = outerH - margin.top - margin.bottom;

const svg = d3.select("#chart")
  .attr("width", outerW).attr("height", outerH)
  .append("g").attr("transform", `translate(${margin.left},${margin.top})`);

const tooltip = d3.select("#tt");

function normText(s){ return (s ?? "").replace(/\u00A0/g," ").trim(); }

d3.csv(CSV_FILE).then(raw => {
  const cols = Object.keys(raw[0] || {});
  const C_SSE="Formula (SSE)", C_CATH="Cathode", C_CYCLE="Cycle Life";

  const data = raw.map(d => ({
    SSE: normText(d[C_SSE]),
    Cathode: normText(d[C_CATH]),
    Cycle: +d[C_CYCLE]
  })).filter(d => d.SSE && d.Cathode && Number.isFinite(d.Cycle) && d.Cycle > 0);

  if (!data.length) {
    d3.select("#status").text("No usable data found."); 
    return;
  }
  d3.select("#status").text(`Rows loaded: ${data.length}`);

  const sseDomain = Array.from(new Set(data.map(d => d.SSE))).sort(d3.ascending);
  const cathDomain = Array.from(new Set(data.map(d => d.Cathode))).sort(d3.ascending);

  const x = d3.scaleBand().domain(cathDomain).range([0, width]).padding(0.05);
  const y = d3.scaleBand().domain(sseDomain).range([0, height]).padding(0.05);
  const maxCycle = d3.max(data, d => d.Cycle) || 1;
  const color = d3.scaleSequential(d3.interpolateYlGnBu).domain([0, maxCycle]);

  // Axes
  svg.append("g")
    .attr("transform", `translate(0,${height})`)
    .attr("class","axis")
    .call(d3.axisBottom(x).tickSizeOuter(0))
    .selectAll("text")
      .attr("transform", "rotate(-45)")
      .style("text-anchor", "end");

  svg.append("g")
    .attr("class","axis")
    .call(d3.axisLeft(y).tickSizeOuter(0));

  // Cells
  svg.selectAll(".cell")
    .data(data)
    .enter().append("rect")
      .attr("class", "cell")
      .attr("x", d => x(d.Cathode))
      .attr("y", d => y(d.SSE))
      .attr("width", x.bandwidth())
      .attr("height", y.bandwidth())
      .attr("fill", d => color(d.Cycle))
      .on("mouseover", (ev, d) => {
        tooltip.style("visibility", "visible").html(`
          <b>SSE:</b> ${d.SSE}<br>
          <b>Cathode:</b> ${d.Cathode}<br>
          <b>Cycle life:</b> ${d.Cycle}
        `);
      })
      .on("mousemove", (ev) => {
        tooltip.style("left", (ev.pageX + 12) + "px")
               .style("top", (ev.pageY - 20) + "px");
      })
      .on("mouseout", () => tooltip.style("visibility", "hidden"));

  // Legend
  const legendW = 220, legendH = 10;
  const legend = svg.append("g")
    .attr("transform", `translate(${(width - legendW)/2}, ${-40})`);
  const gradId = "gradHeat";
  const defs = svg.append("defs");
  const grad = defs.append("linearGradient")
    .attr("id", gradId)
    .attr("x1", "0%").attr("x2", "100%");
  const steps = 10;
  for (let i=0; i<=steps; i++) {
    const t = i/steps;
    grad.append("stop").attr("offset", `${t*100}%`)
      .attr("stop-color", color(t*maxCycle));
  }
  legend.append("rect")
    .attr("width", legendW).attr("height", legendH)
    .style("fill", `url(#${gradId})`).attr("stroke", "#aaa");
  const legendScale = d3.scaleLinear().domain([0, maxCycle]).range([0, legendW]);
  legend.append("g")
    .attr("transform", `translate(0,${legendH})`)
    .call(d3.axisBottom(legendScale).ticks(5).tickSize(3));
  legend.append("text")
    .attr("class", "legendTitle")
    .attr("x", legendW / 2)
    .attr("y", -6)
    .attr("text-anchor", "middle")
    .text("Cycle life");
});
</script>
</body>
</html>

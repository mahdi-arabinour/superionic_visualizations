<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Activation Energy vs Conductivity — robust parser</title>
<script src="https://d3js.org/d3.v7.min.js"></script>
<style>
  :root { --panel-w: 320px; }
  body { font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial; background:#f8fafc; margin:16px; color:#0f172a; }
  h2 { margin: 4px 0 10px; font-size: 24px; letter-spacing: .2px; }
  .toolbar { display:flex; flex-wrap: wrap; gap:10px; align-items:center; margin-bottom: 10px; }
  .pill { display:inline-flex; align-items:center; gap:8px; padding:6px 10px; background:#fff; border:1px solid #e5e7eb; border-radius:999px; font-size:12px; }
  .btn { font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid #e5e7eb; background:#fff; cursor:pointer; }
  .btn:hover { background:#f1f5f9; }
  .wrap { display:grid; grid-template-columns: 1fr var(--panel-w); gap:16px; align-items: start; }
  .viz { background:#fff; border:1px solid #e5e7eb; border-radius:12px; box-shadow:0 1px 2px rgba(0,0,0,.04); }
  .axis path, .axis line { stroke:#94a3b8; }
  .axis text { fill:#475569; font-size:12px; }
  .grid line { stroke:#e2e8f0; }
  .tooltip { position:fixed; pointer-events:none; background:#ffffff; border:1px solid #e5e7eb; border-radius:8px; padding:8px 10px; font-size:12px; color:#111827; box-shadow: 0 8px 16px rgba(0,0,0,.08); }
  .empty { text-anchor:middle; fill:#64748b; font-size:14px; }
  .sidepanels { position:sticky; top:8px; display:flex; flex-direction:column; gap:12px; }
  .panel { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:10px 12px; }
  .panel h3 { font-size:13px; margin:0 0 8px; text-align:center; color:#0f172a; }
  .legend-item { display:flex; align-items:center; gap:8px; font-size:12px; margin:4px 0; cursor:pointer; user-select:none; }
  .legend-item.disabled { opacity:.35; text-decoration: line-through; }
  .legend-symbol { width:18px; height:18px; flex:0 0 18px; }
  .controls { display:flex; gap:6px; justify-content:space-between; margin-bottom:6px; }
  .controls button { font-size:11px; padding:4px 6px; border-radius:6px; border:1px solid #cbd5e1; background:#f8fafc; cursor:pointer; }
  .controls button:hover { background:#eef2f7; }
  .foot { margin-top:6px; color:#64748b; font-size:12px; }
  details { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:10px 12px; }
  details summary { cursor:pointer; font-weight:600; color:#0f172a; }
  .diag { font-size:12px; color:#334155; }
  .kpi { display:flex; gap:16px; flex-wrap:wrap; align-items:center; }
  .kpi span { color:#64748b; }
  .kpi b { color:#111827; }
  @media (max-width: 1000px) { :root { --panel-w: 100%; } .wrap { grid-template-columns: 1fr; } }
</style>
</head>
<body>

<h2>Activation Energy vs Conductivity</h2>
<div class="toolbar">
  <span class="pill"><input type="checkbox" id="eaFilter" checked> Show only Ea ≤ 1 eV</span>
  <span class="pill">
    Ea parsing:
    <label style="margin-left:6px;"><input type="radio" name="eaMode" value="strict"> strict</label>
    <label style="margin-left:6px;"><input type="radio" name="eaMode" value="relaxed" checked> relaxed</label>
  </span>
  <button class="btn" id="resetAll">Reset filters</button>
  <span id="status" style="font-size:12px;color:#64748b;"></span>
</div>

<div class="wrap">
  <svg class="viz" width="920" height="580" role="img" aria-labelledby="title desc">
    <title id="title">Activation energy (Y) vs conductivity (X)</title>
    <desc id="desc">X is log10(σ). Color encodes structure group; symbol encodes ion type.</desc>
  </svg>

  <div class="sidepanels">
    <div class="panel" id="colorLegend">
      <div class="controls">
        <button id="colorAll">Show all</button>
        <button id="colorNone">Hide all</button>
      </div>
      <h3>Structure Group (Color)</h3>
      <div id="colorItems"></div>
    </div>

    <div class="panel" id="shapeLegend">
      <div class="controls">
        <button id="shapeAll">Show all</button>
        <button id="shapeNone">Hide all</button>
      </div>
      <h3>Ion Type (Shape)</h3>
      <div id="shapeItems"></div>
    </div>

    <details open>
      <summary>Diagnostics</summary>
      <div class="diag" id="diag"></div>
    </details>
    <div class="foot" id="footnote"></div>
  </div>
</div>

<script>
const CSV_FILE = "data.csv";

const COL = {
  formula: "Formula (Chemical)",
  ion: "Ion Type",
  sigmaTemp: "Conductivity σ (S·cm⁻¹) / Temp (°C) normalized",
  struct: "Structure Group",
  ea: "Activation Energy Ea (eV)"
};

const toAsciiPlus = s => s.replace(/⁺/g, "+").replace(/\s+/g, " ").trim();
const normLabel = s => (!s ? "" : toAsciiPlus(String(s)).replace(/\u00A0/g, " ").trim());

function parseNumberFlexible(v) {
  if (v == null) return NaN;
  let s = String(v).trim();
  if (!s) return NaN;
  s = s.replace(/,/g, "");
  s = s.replace(/⁻/g, "-").replace(/–/g, "-");
  s = s.replace(/×\s*10\^?\s*([-+]?\d+)/i, (m, p1) => "e" + p1);
  s = s.replace(/x\s*10\^?\s*([-+]?\d+)/i, (m, p1) => "e" + p1);
  s = s.replace(/10\^([⁰¹²³⁴⁵⁶⁷⁸⁹]+)/, (m, sup) => {
    const map = {"⁰":"0","¹":"1","²":"2","³":"3","⁴":"4","⁵":"5","⁶":"6","⁷":"7","⁸":"8","⁹":"9"};
    return "10^" + sup.split("").map(ch => map[ch] ?? ch).join("");
  }).replace(/10\^([-+]?\d+)/, (m,p1)=>"e"+p1);
  const n = Number(s);
  return Number.isFinite(n) ? n : NaN;
}

// Relaxed Ea parser: supports ranges (~, -, –, 'to'), multiple values separated by ';', and strips parenthetical notes.
function parseEa(value, mode="relaxed") {
  if (value == null) return NaN;
  let s = String(value).trim();
  if (!s) return NaN;
  if (mode === "strict") return parseNumberFlexible(s);

  // relaxed:
  s = s.replace(/[\u223C~≈]/g, "");            // ~ ≈
  s = s.replace(/\(.*?\)/g, "");               // drop (...) notes
  const parts = s.split(";").map(x => x.trim()).filter(Boolean);
  if (!parts.length) return NaN;

  function toNum(t) {
    // handle ranges: a-b, a–b, a to b
    const range = t.match(/([-+]?\d*\.?\d+)\s*(?:-|–|to)\s*([-+]?\d*\.?\d+)/i);
    if (range) {
      const a = parseNumberFlexible(range[1]);
      const b = parseNumberFlexible(range[2]);
      if (Number.isFinite(a) && Number.isFinite(b)) return (a + b) / 2;
    }
    // otherwise first numeric in the token
    const m = t.match(/[-+]?\d*\.?\d+(?:e[-+]?\d+)?/i);
    return m ? parseNumberFlexible(m[0]) : NaN;
  }

  // prefer first token but allow fallback to any numeric across tokens
  let n = toNum(parts[0]);
  if (Number.isFinite(n)) return n;
  for (const p of parts.slice(1)) {
    n = toNum(p);
    if (Number.isFinite(n)) return n;
  }
  return NaN;
}

// Pick σ at ~25 °C from a combined "σ / Temp" string
function pickSigmaAtRT(cell) {
  if (cell == null) return {sigma: NaN, temp: NaN, raw: ""};
  const raw = String(cell);
  const parts = raw.split(/[;,|]/).map(s => s.trim()).filter(Boolean);
  let best = {sigma: NaN, temp: NaN, raw: ""};
  let bestScore = Infinity;

  function extractOne(s) {
    const sigMatch = s.match(/[-+]?[\d.,]*\d(?:\.\d+)?(?:e[-+]?\d+)?/i);
    const tempMatch = s.match(/(-?\d+(?:\.\d+)?)\s*°?\s*c/i) || (/\bRT\b/i.test(s) ? {1:"25"} : null);
    const sigma = sigMatch ? parseNumberFlexible(sigMatch[0]) : NaN;
    const temp  = tempMatch ? parseFloat(tempMatch[1]) : NaN;
    return {sigma, temp, raw:s};
  }

  if (parts.length === 0) return extractOne(raw);

  for (const p of parts) {
    const it = extractOne(p);
    if (!Number.isFinite(it.sigma) || it.sigma <= 0) continue;
    const t = Number.isFinite(it.temp) ? it.temp : 25;
    const score = Math.abs(t - 25);
    if (score < bestScore) { best = it; bestScore = score; }
  }
  if (!Number.isFinite(best.sigma)) return extractOne(raw);
  return best;
}

const margin = {top: 40, right: 20, bottom: 64, left: 74},
      outerW = 920, outerH = 580,
      width  = outerW - margin.left - margin.right,
      height = outerH - margin.top - margin.bottom;

const root = d3.select("svg.viz");
const svg = root.append("g").attr("transform", `translate(${margin.left},${margin.top})`);
const gridG = svg.append("g").attr("class","grid");
const xAxisG = svg.append("g").attr("class","axis").attr("transform", `translate(0,${height})`);
const yAxisG = svg.append("g").attr("class","axis");
const tooltip = d3.select("body").append("div").attr("class","tooltip").style("opacity",0);

let global = {raw:[], allData:[], structureGroups:[], ionTypes:[], points:null};

function render(modeEa="relaxed"){
  svg.selectAll("*").remove();
  gridG.selectAll("*").remove();
  xAxisG.selectAll("*").remove();
  yAxisG.selectAll("*").remove();

  const allData = global.raw.map(d => {
    const pick = pickSigmaAtRT(d[COL.sigmaTemp]);
    const log10_sigma = (Number.isFinite(pick.sigma) && pick.sigma > 0) ? Math.log10(pick.sigma) : NaN;
    const ionSafe = normLabel(d[COL.ion]) || "Unknown";
    const structSafe = normLabel(d[COL.struct]) || "Others";
    const Ea_eV = parseEa(d[COL.ea], modeEa);
    return {
      Formula: (d[COL.formula] || "").trim(),
      StructureGroup: structSafe,
      IonType: ionSafe,
      Ea_eV,
      sigma: pick.sigma, tempC: pick.temp, log10_sigma, sigmaRaw: pick.raw
    };
  });

  const valid = allData.filter(d => Number.isFinite(d.Ea_eV) && Number.isFinite(d.log10_sigma));
  const structureGroups = [...new Set(valid.map(d => d.StructureGroup))];
  const ionTypes = [...new Set(valid.map(d => d.IonType))];

  global.allData = valid;
  global.structureGroups = structureGroups;
  global.ionTypes = ionTypes;

  const status = document.getElementById("status");
  status.textContent = `loaded: ${global.raw.length}, parsed: ${valid.length}`;

  // axes
  const x = d3.scaleLinear().domain(d3.extent(valid, d => d.log10_sigma)).nice().range([0, width]);
  const y = d3.scaleLinear().domain(d3.extent(valid, d => d.Ea_eV)).nice().range([height, 0]);
  const color = d3.scaleOrdinal(d3.schemeTableau10).domain(structureGroups);
  const shapes = [d3.symbolCircle, d3.symbolSquare, d3.symbolTriangle, d3.symbolDiamond, d3.symbolCross, d3.symbolStar, d3.symbolWye];
  const shape = t => shapes[(Math.max(0, ionTypes.indexOf(t))) % shapes.length];

  xAxisG.call(d3.axisBottom(x));
  yAxisG.call(d3.axisLeft(y));
  gridG.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(x).tickSize(-height).tickFormat(""));
  gridG.append("g").call(d3.axisLeft(y).tickSize(-width).tickFormat(""));
  svg.append("text").attr("x", width/2).attr("y", height + 48).attr("text-anchor","middle").attr("fill","#0f172a").attr("font-size",13).text("log₁₀(Conductivity σ) (S·cm⁻¹)");
  svg.append("text").attr("transform","rotate(-90)").attr("x", -height/2).attr("y", -56).attr("text-anchor","middle").attr("fill","#0f172a").attr("font-size",13).text("Activation Energy Ea (eV)");

  const points = svg.selectAll(".point").data(valid).enter().append("path")
    .attr("class","point")
    .attr("transform", d => `translate(${x(d.log10_sigma)},${y(d.Ea_eV)})`)
    .attr("d", d3.symbol().type(d => shape(d.IonType)).size(110)())
    .attr("fill", d => color(d.StructureGroup) || "#94a3b8")
    .attr("stroke","#0f172a").attr("stroke-width",0.6).attr("opacity",0.92)
    .on("mouseover", (event, d) => {
      const sigmaStr = Number.isFinite(d.sigma) ? d.sigma.toExponential(3) : "—";
      tooltip.style("opacity", 1).html(
        `<div><b>${d.Formula || "—"}</b></div>
         <div>Structure: ${d.StructureGroup || "—"}</div>
         <div>Ion: ${d.IonType || "—"}</div>
         <div>Ea: ${d.Ea_eV.toFixed(3)} eV</div>
         <div>σ: ${sigmaStr} S·cm⁻¹ ${Number.isFinite(d.tempC)?`@ ${d.tempC}°C`:""}</div>
         <div>log₁₀σ: ${d.log10_sigma.toFixed(3)}</div>`);
    })
    .on("mousemove", (event) => { tooltip.style("left",(event.clientX+14)+"px").style("top",(event.clientY+14)+"px"); })
    .on("mouseout", () => tooltip.style("opacity", 0));

  // store for filter
  global.points = points;

  // legends
  const colorItems = d3.select("#colorItems").html("");
  structureGroups.forEach(s => {
    const item = colorItems.append("div").attr("class","legend-item");
    const sym = item.append("svg").attr("class","legend-symbol");
    sym.append("rect").attr("x",2).attr("y",2).attr("width",14).attr("height",14).attr("fill", color(s)).attr("stroke","#1f2937").attr("stroke-width",0.6);
    item.append("span").text(s);
  });

  const shapeItems = d3.select("#shapeItems").html("");
  ionTypes.forEach(t => {
    const item = shapeItems.append("div").attr("class","legend-item");
    const symSvg = item.append("svg").attr("class","legend-symbol").attr("viewBox","-10 -10 20 20");
    symSvg.append("path").attr("d", d3.symbol().type(shape(t)).size(120)()).attr("fill","#475569").attr("stroke","#1f2937").attr("stroke-width",0.6);
    item.append("span").text(t);
  });

  // filters
  const eaCheckbox = document.getElementById("eaFilter");
  let activeStructures = new Set(structureGroups);
  let activeIons = new Set(ionTypes);

  function updateVisibility(){
    let visibleCount = 0;
    points.style("display", d => {
      const passEa = !eaCheckbox.checked || d.Ea_eV <= 1;
      const passStruct = activeStructures.has(d.StructureGroup);
      const passIon = activeIons.has(d.IonType);
      const show = passEa && passStruct && passIon;
      if (show) visibleCount++;
      return show ? null : "none";
    });
    status.textContent = `loaded: ${global.raw.length}, parsed: ${valid.length}, showing: ${visibleCount}`;
  }

  // interactive legend toggles
  colorItems.selectAll(".legend-item").on("click", function(_, s){
    const name = d3.select(this).select("span").text();
    if (activeStructures.has(name)) activeStructures.delete(name); else activeStructures.add(name);
    d3.select(this).classed("disabled", !activeStructures.has(name));
    updateVisibility();
  });

  shapeItems.selectAll(".legend-item").on("click", function(_, t){
    const name = d3.select(this).select("span").text();
    if (activeIons.has(name)) activeIons.delete(name); else activeIons.add(name);
    d3.select(this).classed("disabled", !activeIons.has(name));
    updateVisibility();
  });

  document.getElementById("colorAll").onclick = ()=>{
    activeStructures = new Set(structureGroups);
    colorItems.selectAll(".legend-item").classed("disabled", false);
    updateVisibility();
  };
  document.getElementById("colorNone").onclick = ()=>{
    activeStructures.clear();
    colorItems.selectAll(".legend-item").classed("disabled", true);
    updateVisibility();
  };
  document.getElementById("shapeAll").onclick = ()=>{
    activeIons = new Set(ionTypes);
    shapeItems.selectAll(".legend-item").classed("disabled", false);
    updateVisibility();
  };
  document.getElementById("shapeNone").onclick = ()=>{
    activeIons.clear();
    shapeItems.selectAll(".legend-item").classed("disabled", true);
    updateVisibility();
  };

  document.getElementById("resetAll").onclick = ()=>{
    document.querySelector('input[name="eaMode"][value="relaxed"]').checked = true;
    document.getElementById("eaFilter").checked = true;
    render("relaxed");
  };
  document.getElementById("eaFilter").onchange = updateVisibility;

  // diagnostics
  const diag = document.getElementById("diag");
  const total = global.raw.length;
  const eaBad = allData.filter(d => !Number.isFinite(d.Ea_eV) && Number.isFinite(d.log10_sigma)).length;
  const sigmaBad = allData.filter(d => Number.isFinite(d.Ea_eV) && !Number.isFinite(d.log10_sigma)).length;
  const bothBad = allData.filter(d => !Number.isFinite(d.Ea_eV) && !Number.isFinite(d.log10_sigma)).length;
  diag.innerHTML = `<div class="kpi"><span>Total:</span><b>${total}</b>
                    <span>Parsed:</span><b>${valid.length}</b>
                    <span>Unparsable Ea only:</span><b>${eaBad}</b>
                    <span>Unparsable σ only:</span><b>${sigmaBad}</b>
                    <span>Both unparsable:</span><b>${bothBad}</b></div>`;

  updateVisibility();
}

d3.csv(CSV_FILE).then(raw => {
  global.raw = raw;
  render("relaxed");

  // listen for Ea mode toggle
  document.querySelectorAll('input[name="eaMode"]').forEach(r => {
    r.addEventListener('change', (e)=> render(e.target.value));
  });

  document.getElementById("footnote").textContent = "X = log10(σ) parsed from Conductivity/Temp (prefers ~25°C); Y = Ea (eV). Ea relaxed mode accepts ranges (~, -, – , 'to') using midpoint and strips notes; multiple values ';' use the first numeric.";
}).catch(err => {
  console.error(err);
  svg.append("text").attr("class","empty").attr("x", 450).attr("y", 280).text("Could not load data.csv");
});
</script>
</body>
</html>

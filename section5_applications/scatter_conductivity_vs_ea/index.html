<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Activation Energy vs Conductivity</title>
<script src="https://d3js.org/d3.v7.min.js"></script>
<style>
  :root { --side: 260px; }
  body { font-family: sans-serif; background:#fafafa; margin:24px; color:#111; }
  h2 { margin:0 0 12px; }
  .toolbar { display:flex; gap:10px; align-items:center; margin:10px 0 12px; }
  .pill { display:inline-flex; align-items:center; gap:8px; padding:6px 10px; background:#fff; border:1px solid #ddd; border-radius:999px; font-size:13px; }
  .wrap { display:grid; grid-template-columns: 1fr var(--side); gap:16px; align-items:start; }
  svg { width: 950px; height: 620px; background:#fff; border:1px solid #e5e5e5; border-radius:10px; }
  .axis-label { font-size: 14px; font-weight: 600; }
  .point { stroke:#333; opacity:.9; }
  .tooltip { position:fixed; pointer-events:none; background:#fff; border:1px solid #ddd; padding:6px 10px; border-radius:6px; font-size:13px; box-shadow:0 2px 10px rgba(0,0,0,.08); opacity:0; }
  .side { position:sticky; top:16px; background:#fff; border:1px solid #e5e5e5; border-radius:10px; padding:12px; }
  .legend-title { font-weight:700; margin:12px 0 6px; font-size:14px; }
  .legend-controls { display:flex; gap:6px; margin: 4px 0 6px; }
  .legend-controls button { font-size:12px; padding:2px 6px; border:1px solid #ccc; background:#fff; cursor:pointer; border-radius:4px; }
  .legend-item { display:flex; align-items:center; gap:6px; margin:4px 0; cursor:pointer; user-select:none; }
  .legend-item.disabled { opacity:.35; text-decoration:line-through; }
  .legend-symbol { width:18px; height:18px; }
</style>
</head>
<body>

<h2>Activation Energy (eV) vs Conductivity (S/cm)</h2>
<div class="toolbar">
  <label class="pill"><input id="eaToggle" type="checkbox" checked> Show only Ea ≤ 1 eV</label>
</div>

<div class="wrap">
  <svg></svg>

  <div class="side">
    <div class="legend-title">Structure Group (color)</div>
    <div class="legend-controls">
      <button id="color-show-all">Show all</button>
      <button id="color-hide-all">Hide all</button>
    </div>
    <div id="legend-color-items"></div>

    <div class="legend-title" style="margin-top:14px;">Ion Type (shape)</div>
    <div class="legend-controls">
      <button id="shape-show-all">Show all</button>
      <button id="shape-hide-all">Hide all</button>
    </div>
    <div id="legend-shape-items"></div>
  </div>
</div>

<div class="tooltip"></div>

<script>
const svg = d3.select("svg");
const width = svg.attr("width") || 950;
const height = svg.attr("height") || 620;
const margin = {top:40, right:40, bottom:60, left:80};
const innerW = width - margin.left - margin.right;
const innerH = height - margin.top - margin.bottom;

const g = svg.append("g").attr("transform",`translate(${margin.left},${margin.top})`);
const tooltip = d3.select(".tooltip");

const SHAPES = [
  d3.symbolCircle, d3.symbolSquare, d3.symbolTriangle,
  d3.symbolDiamond, d3.symbolCross, d3.symbolStar, d3.symbolWye
];

// ✅ Custom structure colors
const structureColors = {
  "Others": "#9e9e9e",
  "Polymeric": "#ff7043",
  "Argyrodite": "#ab47bc",
  "Halide": "#26a69a",
  "Amorphous": "#f6bf26",
  "NASICON": "#66bb6a",
  "Anti-perovskite": "#2196f3",
  "Spinel": "#8d6e63" 
};

d3.csv("data.csv").then(data => {
  const rows = data.map(d => ({
    Ea: +d["Activation Energy Ea (eV)"],
    cond: +d["Conductivity σ (S·cm⁻¹) / Temp (°C) normalized"],
    ion: (d["Ion Type"] || "Unknown").toString().trim() || "Unknown",
    structure: (d["Structure Group"] || "Others").toString().trim() || "Others"
  })).filter(d => isFinite(d.Ea) && isFinite(d.cond) && d.cond > 0);

  const x = d3.scaleLinear()
    .domain(d3.extent(rows, d => d.Ea)).nice()
    .range([0, innerW]);
  const y = d3.scaleLog()
    .domain(d3.extent(rows, d => d.cond)).nice()
    .range([innerH, 0]);

  const structureGroups = Array.from(new Set(rows.map(d => d.structure)));
  const ionTypes = Array.from(new Set(rows.map(d => d.ion)));

  const color = d3.scaleOrdinal()
    .domain(structureGroups)
    .range(structureGroups.map(s => structureColors[s] || "#9e9e9e"));

  const shapeFor = d3.scaleOrdinal().domain(ionTypes).range(SHAPES);

  // Axes
  g.append("g").attr("transform",`translate(0,${innerH})`).call(d3.axisBottom(x));
  g.append("g").call(d3.axisLeft(y).ticks(6, "~g"));

  g.append("text").attr("class","axis-label")
    .attr("x", innerW/2).attr("y", innerH+45)
    .attr("text-anchor","middle").text("Activation Energy (eV)");
  g.append("text").attr("class","axis-label")
    .attr("x",-innerH/2).attr("y",-55).attr("transform","rotate(-90)")
    .attr("text-anchor","middle").text("Conductivity (S/cm)");

  // Points
  const points = g.selectAll(".point").data(rows).enter()
    .append("path")
    .attr("class","point")
    .attr("transform", d => `translate(${x(d.Ea)},${y(d.cond)})`)
    .attr("d", d3.symbol().type(d => shapeFor(d.ion)).size(90))
    .attr("fill", d => color(d.structure))
    .on("mouseover", (e,d) => {
      tooltip.style("opacity",1)
        .html(`Ion: ${d.ion}<br>Structure: ${d.structure}<br>Ea: ${d.Ea}<br>σ: ${d.cond}`)
        .style("left", (e.clientX+12)+"px").style("top",(e.clientY+12)+"px");
    })
    .on("mouseout", () => tooltip.style("opacity",0));

  // Filtering state
  let activeStructures = new Set(structureGroups);
  let activeIons = new Set(ionTypes);
  const eaToggle = document.getElementById("eaToggle");

  function updateVisibility() {
    const eaCut = eaToggle.checked;
    points.attr("display", d => {
      const ok = activeStructures.has(d.structure) &&
                 activeIons.has(d.ion) &&
                 (!eaCut || d.Ea <= 1);
      return ok ? null : "none";
    });
  }
  eaToggle.addEventListener("change", updateVisibility);

  // Color legend (Structure)
  const colorWrap = d3.select("#legend-color-items");
  const colorItems = colorWrap.selectAll(".legend-item")
    .data(structureGroups)
    .enter().append("div").attr("class","legend-item");

  colorItems.each(function(s){
    const item = d3.select(this);
    item.append("svg").attr("class","legend-symbol")
      .append("rect").attr("width",14).attr("height",14)
      .attr("fill", color(s)).attr("stroke","#444");
    item.append("span").text(s);
  }).on("click", function(_, s){
    if (activeStructures.has(s)) activeStructures.delete(s); else activeStructures.add(s);
    d3.select(this).classed("disabled", !activeStructures.has(s));
    updateVisibility();
  });

  d3.select("#color-show-all").on("click", () => {
    activeStructures = new Set(structureGroups);
    colorItems.classed("disabled", false);
    updateVisibility();
  });
  d3.select("#color-hide-all").on("click", () => {
    activeStructures.clear();
    colorItems.classed("disabled", true);
    updateVisibility();
  });

  // Shape legend (Ion)
  const shapeWrap = d3.select("#legend-shape-items");
  const shapeItems = shapeWrap.selectAll(".legend-item")
    .data(ionTypes)
    .enter().append("div").attr("class","legend-item");

  shapeItems.each(function(t){
    const item = d3.select(this);
    const sv = item.append("svg").attr("class","legend-symbol").attr("viewBox","-10 -10 20 20");
    sv.append("path")
      .attr("d", d3.symbol().type(shapeFor(t)).size(120)())
      .attr("fill","#777").attr("stroke","#333");
    item.append("span").text(t);
  }).on("click", function(_, t){
    if (activeIons.has(t)) activeIons.delete(t); else activeIons.add(t);
    d3.select(this).classed("disabled", !activeIons.has(t));
    updateVisibility();
  });

  d3.select("#shape-show-all").on("click", () => {
    activeIons = new Set(ionTypes);
    shapeItems.classed("disabled", false);
    updateVisibility();
  });
  d3.select("#shape-hide-all").on("click", () => {
    activeIons.clear();
    shapeItems.classed("disabled", true);
    updateVisibility();
  });

  updateVisibility();
});
</script>
</body>
</html>

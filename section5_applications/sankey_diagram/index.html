<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Sankey — Anode → Structure → Ion → Cathode</title>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; background:#fff; color:#111; margin:28px; }
  h2 { margin:0 0 8px; }
  .controls { margin:8px 0 14px; display:flex; gap:10px; align-items:center; }
  svg { background:#fff; border:1px solid #ccc; border-radius:8px; }
  .node rect { stroke:#666; }
  .link { fill:none; stroke-opacity:.35; }
  .tooltip { position:absolute; background:#fff; border:1px solid #ccc; border-radius:5px;
             padding:6px 8px; font-size:11px; box-shadow:0 2px 6px rgba(0,0,0,.15); pointer-events:none; }
  #status { margin-top:8px; font-size:12px; color:#333; }
  #status.error { color:#b00020; }
</style>
</head>
<body>

<h2>Sankey — Anode → Structure → Ion → Cathode</h2>
<div class="controls">
  <label>CSV:</label>
  <select id="dataset">
    <option value="data_simple_thresholded.csv" selected>Thresholded (simple)</option>
    <option value="data_simple_raw.csv">RAW (simple)</option>
  </select>
  <label>Min count:</label>
  <input id="minCount" type="number" value="3" min="1" step="1" style="width:70px" />
  <button id="apply">Apply</button>
</div>

<svg id="chart" width="1200" height="720"></svg>
<div id="tt" class="tooltip" style="visibility:hidden"></div>
<div id="status">Loading…</div>

<script>
const svg = d3.select("#chart"),
      width = +svg.attr("width"),
      height = +svg.attr("height");
const statusEl = d3.select("#status");
const color = d3.scaleOrdinal(d3.schemeTableau10);
const tooltip = d3.select("#tt");

const sankey = d3.sankey()
  .nodeWidth(14)
  .nodePadding(18)
  .extent([[12, 12], [width - 12, height - 12]]);

// Try multiple header sets
function normalizeLinks(raw) {
  const cols = raw.columns ? raw.columns.map(c => c.trim()) : [];
  // Best candidates
  const variants = [
    {s:"SourceName", t:"TargetName", v:"Count"},
    {s:"Source",     t:"Target",     v:"Count"},
    {s:"source",     t:"target",     v:"value"},
    {s:"Source",     t:"Target",     v:"Value"},
  ];
  let map = null;
  for (const cand of variants) {
    if (cols.includes(cand.s) && cols.includes(cand.t) && cols.includes(cand.v)) {
      map = cand; break;
    }
  }
  if (!map) {
    throw new Error(`CSV headers must include one of:
- SourceName,TargetName,Count
- Source,Target,Count
- source,target,value
Found: ${cols.join(", ")}`);
  }
  return raw.map(d => ({
    SourceName: String(d[map.s]).trim(),
    TargetName: String(d[map.t]).trim(),
    Count: +d[map.v]
  })).filter(d => d.SourceName && d.TargetName && d.Count > 0);
}

function buildGraph(links, minCount){
  const flinks = links.filter(d => +d.Count >= minCount);
  const nameToIndex = new Map();
  const id = name => (nameToIndex.has(name) ? nameToIndex.get(name) : (nameToIndex.set(name, nameToIndex.size), nameToIndex.get(name)));
  flinks.forEach(d => { d.source = id(d.SourceName); d.target = id(d.TargetName); });
  const nodes = Array.from(nameToIndex.entries()).sort((a,b)=>a[1]-b[1]).map(([name]) => ({name}));
  return { nodes, links: flinks.map(d => ({ source:d.source, target:d.target, value:+d.Count })) };
}

function draw(links, minCount){
  const graph = buildGraph(links, minCount);
  svg.selectAll("*").remove();
  if (!graph.links.length){
    statusEl.attr("class","error").text("No links after filtering. Try lowering Min count or check CSV headers/values.");
    return;
  }
  sankey(graph);

  // Links
  svg.append("g").attr("fill","none").selectAll("path")
    .data(graph.links).enter().append("path")
      .attr("class","link")
      .attr("d", d3.sankeyLinkHorizontal())
      .attr("stroke", d => color(d.source % 10))
      .attr("stroke-width", d => Math.max(1, d.width))
      .on("mouseover", (ev,d) => {
        tooltip.style("visibility","visible").html(
          `${graph.nodes[d.source].name} → ${graph.nodes[d.target].name}<br><b>${d.value}</b> samples`
        );
      })
      .on("mousemove", ev => tooltip.style("left",(ev.pageX+12)+"px").style("top",(ev.pageY-20)+"px"))
      .on("mouseout", () => tooltip.style("visibility","hidden"));

  // Nodes
  const node = svg.append("g").selectAll("g").data(graph.nodes).enter().append("g").attr("class","node");
  node.append("rect")
      .attr("x", d => d.x0).attr("y", d => d.y0)
      .attr("height", d => Math.max(1, d.y1 - d.y0))
      .attr("width", d => d.x1 - d.x0)
      .attr("fill", d => color(d.index % 10)).attr("opacity", .85);
  node.append("text")
      .attr("x", d => d.x0 < width/2 ? d.x1 + 6 : d.x0 - 6)
      .attr("y", d => (d.y1 + d.y0)/2).attr("dy",".35em")
      .attr("text-anchor", d => d.x0 < width/2 ? "start" : "end")
      .style("font-size","11px").text(d => d.name);

  statusEl.attr("class",null).text(`Loaded rows: ${links.length} | Drawn: ${graph.links.length} links, ${graph.nodes.length} nodes | minCount=${minCount}`);
}

function loadAndDraw(){
  const file = document.getElementById("dataset").value;
  const minCount = +document.getElementById("minCount").value || 1;
  statusEl.attr("class",null).text(`Loading ${file}…`);
  d3.csv(file).then(raw => {
    const links = normalizeLinks(raw);
    draw(links, minCount);
  }).catch(err => {
    console.error(err);
    statusEl.attr("class","error").text(err.message || `Failed to load ${file}. If opening locally, run: python3 -m http.server`);
  });
}

document.getElementById("apply").addEventListener("click", loadAndDraw);
loadAndDraw();
</script>
</body>
</html>

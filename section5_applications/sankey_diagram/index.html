<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Battery Material Flow Sankey</title>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>
<style>
  body { font-family: sans-serif; margin: 15px; background: #f9f9f9; }
  h1 { font-size: 1.4em; margin-bottom: 10px; }
  svg { width: 100%; height: 85vh; background: white; }
  .node rect { cursor: move; fill-opacity: 0.9; shape-rendering: crispEdges; }
  .node text { pointer-events: none; text-shadow: 0 1px 0 #fff; font-size: 12px; }
  .link { fill: none; stroke-opacity: 0.4; }
  .link:hover { stroke-opacity: 0.8; }
</style>
</head>
<body>
<h1>Battery Material Flow Sankey</h1>

<div>
  <label>Data:
    <select id="dataSelect">
      <option value="data_thresholded.csv">Thresholded (layered)</option>
      <option value="data_raw.csv">Raw (layered)</option>
    </select>
  </label>

  <label>Layout:
    <select id="layoutSelect">
      <option value="anode-sse-cathode">Anode → SSE Structure Type → Cathode</option>
      <option value="anode-sse-ion-cathode">Anode → Structure Type → Ion Type → Cathode</option>
    </select>
  </label>

  <label>Min count:
    <input id="minCount" type="number" value="1" min="1" style="width:60px;">
  </label>

  <button id="renderBtn">Render</button>
  <button id="downloadBtn">Download SVG</button>
</div>

<svg id="sankey"></svg>

<script>
const svg = d3.select("#sankey");
const width = window.innerWidth - 40, height = window.innerHeight * 0.8;
const sankey = d3.sankey().nodeWidth(20).nodePadding(15).extent([[1,1],[width-1,height-6]]);
const color = d3.scaleOrdinal(d3.schemeTableau10);

document.getElementById("renderBtn").addEventListener("click", render);
document.getElementById("downloadBtn").addEventListener("click", downloadSVG);

function sanitize(s) {
  return s ? s.trim().replace(/\s+/g," ") : "";
}

async function render() {
  svg.selectAll("*").remove();
  const file = document.getElementById("dataSelect").value;
  const minCount = +document.getElementById("minCount").value || 1;
  const layout = document.getElementById("layoutSelect").value;

  console.log(`Loading ${file}...`);
  let data;
  try {
    data = await d3.csv(file, d => ({
      Source: sanitize(d.Source),
      SourceName: sanitize(d.SourceName),
      TargetLayer: sanitize(d.TargetLayer),
      TargetName: sanitize(d.TargetName),
      Count: +d.Count || 1
    }));
  } catch(e) {
    console.error("Failed to load:", e);
    alert("Could not load " + file);
    return;
  }
  console.log(`Loaded ${data.length} rows from ${file}`);

  // filter
  data = data.filter(d => d.SourceName && d.TargetName && d.Count >= minCount);
  if (!data.length) { alert("No data after filtering."); return; }

  // fix circulars
  const nodes = [], links = [];
  const nodeByName = new Map();
  function node(name, layer) {
    const key = name + "|" + layer;
    if (!nodeByName.has(key)) nodeByName.set(key, {name, layer});
    return nodeByName.get(key);
  }

  for (const d of data) {
    const src = node(d.SourceName, d.Source);
    const tgt = node(d.TargetName, d.TargetLayer);
    if (src.name === tgt.name && src.layer === tgt.layer) continue;
    links.push({source: src, target: tgt, value: d.Count});
  }

  const graph = {nodes: Array.from(nodeByName.values()), links};
  sankey(graph);

  const link = svg.append("g").attr("fill","none").attr("stroke-opacity",0.5)
    .selectAll("path").data(graph.links).join("path")
    .attr("class","link")
    .attr("d", d3.sankeyLinkHorizontal())
    .attr("stroke", d => color(d.source.layer))
    .attr("stroke-width", d => Math.max(1, d.width));

  const node = svg.append("g").selectAll("g").data(graph.nodes).join("g")
    .attr("transform", d => `translate(${d.x0},${d.y0})`);

  node.append("rect")
    .attr("height", d => d.y1 - d.y0)
    .attr("width", sankey.nodeWidth())
    .attr("fill", d => color(d.layer))
    .attr("stroke","#000");

  node.append("text")
    .attr("x", -6)
    .attr("y", d => (d.y1 - d.y0)/2)
    .attr("dy", "0.35em")
    .attr("text-anchor", "end")
    .text(d => d.name)
    .filter(d => d.x0 < width / 2)
    .attr("x", 6 + sankey.nodeWidth())
    .attr("text-anchor", "start");

  console.log(`Rendered ${graph.links.length} links, ${graph.nodes.length} nodes`);
}

function downloadSVG(){
  const serializer = new XMLSerializer();
  const source = serializer.serializeToString(svg.node());
  const blob = new Blob([source], {type: "image/svg+xml;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "sankey.svg";
  a.click(); URL.revokeObjectURL(url);
}
</script>
</body>
</html>

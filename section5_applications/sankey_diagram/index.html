<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Battery Sankey Diagram</title>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>
<style>
  body { font-family: sans-serif; background: #fafafa; margin: 0; padding: 20px; }
  h2 { margin: 0 0 10px; }
  select, input { margin: 0 5px 10px 0; }
  svg { width: 100%; height: 90vh; }
  .node rect { stroke: #000; stroke-width: 0.5px; }
  .node text { font-size: 12px; pointer-events: none; fill: #000; }
  .link { fill: none; stroke-opacity: 0.4; }
  .link:hover { stroke-opacity: 0.8; }
</style>
</head>
<body>

<h2>Battery Material Flow Sankey</h2>

<label>Data:</label>
<select id="dataFile">
  <option value="data_thresholded.csv" selected>Thresholded (layered)</option>
  <option value="data_raw.csv">RAW (layered)</option>
</select>

<label>Layout:</label>
<select id="layoutType">
  <option value="4layer" selected>Anode → Structure Type → Ion Type → Cathode</option>
  <option value="3layer">Anode → SSE Structure Type → Cathode</option>
</select>

<label>Min count:</label>
<input type="number" id="minCount" value="1" min="1" style="width:60px">

<button id="renderBtn">Render</button>
<button id="downloadBtn">Download SVG</button>

<svg id="sankey"></svg>

<script>
const svg = d3.select("#sankey");
const width = window.innerWidth - 40, height = window.innerHeight * 0.85;
const sankey = d3.sankey()
  .nodeWidth(20)
  .nodePadding(15)
  .extent([[1, 1], [width - 1, height - 6]]);

document.getElementById("renderBtn").onclick = render;
document.getElementById("downloadBtn").onclick = () => {
  const serializer = new XMLSerializer();
  const svgString = serializer.serializeToString(document.querySelector("svg"));
  const blob = new Blob([svgString], {type: "image/svg+xml"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "sankey.svg";
  a.click();
  URL.revokeObjectURL(url);
};

function render() {
  const file = document.getElementById("dataFile").value;
  const layout = document.getElementById("layoutType").value;
  const minCount = +document.getElementById("minCount").value;
  svg.selectAll("*").remove();

  d3.csv(file).then(data => {
    // Filter by threshold
    data = data.filter(d => +d.Count >= minCount);

    const links = data.map(d => ({
      source: d.SourceName.trim(),
      target: d.TargetName.trim(),
      value: +d.Count,
      sLayer: d.Source,
      tLayer: d.TargetLayer
    }));

    // Select layout
    const order3 = ["Anode", "SSE Structure Type", "Cathode"];
    const order4 = ["Anode", "Structure Type", "Ion Type", "Cathode"];
    const layerOrder = layout === "4layer" ? order4 : order3;

    // Keep only relevant links
    const filteredLinks = links.filter(l =>
      layerOrder.includes(l.sLayer) && layerOrder.includes(l.tLayer)
    );

    // Build nodes
    const nodes = Array.from(new Set(filteredLinks.flatMap(l => [l.source, l.target])),
      name => ({ name }));

    const nodeIndex = new Map(nodes.map((d, i) => [d.name, i]));
    filteredLinks.forEach(l => {
      l.source = nodeIndex.get(l.source);
      l.target = nodeIndex.get(l.target);
    });

    const graph = { nodes, links: filteredLinks };
    sankey(graph);

    const color = d3.scaleOrdinal(d3.schemeCategory10);

    svg.append("g")
      .selectAll("path")
      .data(graph.links)
      .join("path")
      .attr("class", "link")
      .attr("d", d3.sankeyLinkHorizontal())
      .attr("stroke", d => color(d.sLayer))
      .attr("stroke-width", d => Math.max(1, d.width))
      .append("title")
      .text(d => `${d.sLayer}: ${d.source.name} → ${d.tLayer}: ${d.target.name}\n${d.value}`);

    const node = svg.append("g")
      .selectAll(".node")
      .data(graph.nodes)
      .join("g")
      .attr("class", "node");

    node.append("rect")
      .attr("x", d => d.x0)
      .attr("y", d => d.y0)
      .attr("height", d => d.y1 - d.y0)
      .attr("width", sankey.nodeWidth())
      .attr("fill", d => color(d.name))
      .append("title")
      .text(d => `${d.name}\n${d.value}`);

    node.append("text")
      .attr("x", d => d.x0 - 6)
      .attr("y", d => (d.y1 + d.y0) / 2)
      .attr("dy", "0.35em")
      .attr("text-anchor", "end")
      .text(d => d.name)
      .filter(d => d.x0 < width / 2)
      .attr("x", d => d.x1 + 6)
      .attr("text-anchor", "start");
  });
}

// Render once at start
render();
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Conductivity by Structure Group — Box Plot</title>
<script src="https://d3js.org/d3.v7.min.js"></script>
<style>
  :root { --side: 260px; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#fafafa; color:#111; margin:24px; }
  h2 { margin:0 0 10px; }
  .toolbar { display:flex; gap:10px; align-items:center; margin:10px 0 14px; }
  .wrap { display:grid; grid-template-columns: 1fr var(--side); gap:16px; align-items:start; }
  svg { width: 980px; height: 640px; background:#fff; border:1px solid #e5e5e5; border-radius:10px; }
  .axis-label { font-size:14px; font-weight:600; fill:#222; }
  .grid line { stroke:#eee; }

  .violin { fill-opacity:.75; stroke:#222; stroke-width:.9px; }
  .median { stroke:#e43; stroke-width:2px; }

  .point { opacity:.8; stroke:#333; stroke-width:.4px; }
  .side { position:sticky; top:16px; background:#fff; border:1px solid #e5e5e5; border-radius:10px; padding:12px; }
  .legend-title { font-weight:700; font-size:14px; margin:6px 0; }
  .legend-controls { display:flex; gap:6px; margin: 4px 0 8px; }
  .legend-controls button { font-size:12px; padding:2px 6px; border:1px solid #ccc; background:#fff; cursor:pointer; border-radius:4px; }
  .legend-item { display:flex; align-items:center; gap:8px; margin:6px 0; cursor:pointer; user-select:none; }
  .legend-item.disabled { opacity:.35; text-decoration:line-through; }
  .legend-swatch { width:14px; height:14px; border-radius:3px; border:1px solid #444; }
  .note { font-size:12px; color:#64748b; margin-top:6px; }

  .label-halo { fill:#111; font-weight:700; font-size:12px; paint-order:stroke; stroke:#fff; stroke-width:4px; stroke-linejoin:round; }
  .median-text { fill:#111; font-weight:700; font-size:12px; }
</style>
</head>
<body>

<h2>Conductivity by Structure Group — Box Plot</h2>

<div class="wrap">
  <svg id="chart"></svg>

  <div class="side">
    <div class="legend-title">Ion Type (filter points)</div>
    <div class="legend-controls">
      <button id="showAll">Show all</button>
      <button id="hideAll">Hide all</button>
    </div>
    <div id="legend"></div>
  </div>
</div>

<script>
const COL = {
  struct: "Structure Group",
  ion:    "Ion Type",
  sigma:  "Conductivity σ (S·cm⁻¹) / Temp (°C) normalized"
};

const svg = d3.select("#chart");
svg.attr("width", 980).attr("height", 640);
const width = +svg.attr("width"), height = +svg.attr("height");
const margin = {top: 40, right: 30, bottom: 80, left: 90};
const innerW = width - margin.left - margin.right;
const innerH = height - margin.top - margin.bottom;
const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

// deterministic jitter
function xmur3(str){let h=1779033703^str.length;for(let i=0;i<str.length;i++){h=Math.imul(h^str.charCodeAt(i),3432918353);h=(h<<13)|(h>>>19);}return function(){h=Math.imul(h^(h>>>16),2246822507);h=Math.imul(h^(h>>>13),3266489909);return (h^=h>>>16)>>>0;};}
function mulberry32(a){return function(){let t=a+=0x6D2B79F5;t=Math.imul(t^(t>>>15),t|1);t^=t+Math.imul(t^(t>>>7),t|61);return ((t^(t>>>14))>>>0)/4294967295;};}
function stableJitter(key,half){const seed=xmur3(key)();const rand=mulberry32(seed);return (rand()*2-1)*half;}

const fmtSci = d3.format(".3~e");
const fmtFix4 = d3.format(".4f");

// Structure colors
const structureColors = {
  "Others": "#9e9e9e",
  "Polymeric": "#ff7043",
  "Argyrodite": "#ab47bc",
  "Halide": "#26a69a",
  "Amorphous": "#f6bf26",
  "NASICON": "#66bb6a",
  "Anti-perovskite": "#2196f3",
  "Spinel": "#8d6e63"
};

// Ion colors
const ionColors = {
  "Li+":  "#d81b60",  
  "Na+":  "#1e88e5",  
  "K+":   "#004d40",  
  "Ag+":  "#f48fb1",  
  "O2-":  "#6d4c41",  
  "Zn2+": "#c2185b"
};

d3.csv("data.csv").then(raw => {
  const rows = raw.map(d=>{
    const s=+d[COL.sigma];
    return (Number.isFinite(s)&&s>0)?{
      structure:(d[COL.struct]||"Others").trim()||"Others",
      ion:(d[COL.ion]||"Unknown").trim()||"Unknown",
      sigma:s,
      logSig:Math.log10(s)
    }:null;
  }).filter(Boolean);

  const structures = Array.from(new Set(rows.map(d=>d.structure)));
  const ions = Array.from(new Set(rows.map(d=>d.ion)));

  const x = d3.scaleBand().domain(structures).range([0,innerW]).padding(0.12);
  const y = d3.scaleLinear().domain(d3.extent(rows,d=>d.logSig)).nice().range([innerH,0]);

  g.append("g").attr("transform",`translate(0,${innerH})`)
    .call(d3.axisBottom(x))
    .selectAll("text").attr("transform","rotate(-28)").style("text-anchor","end");
  g.append("g").call(d3.axisLeft(y).ticks(8).tickFormat(v=>`10^${v}`));
  g.append("g").attr("class","grid").call(d3.axisLeft(y).ticks(8).tickSize(-innerW).tickFormat(""));
  g.append("text").attr("class","axis-label").attr("x",innerW/2).attr("y",innerH+62).attr("text-anchor","middle").text("Structure Group");
  g.append("text").attr("class","axis-label").attr("x",-innerH/2).attr("y",-64).attr("transform","rotate(-90)").attr("text-anchor","middle").text("log10(σ) (S·cm)");

  // box stats
  function boxStats(values){
    const v = values.slice().sort(d3.ascending);
    const q1=d3.quantileSorted(v,0.25);
    const q2=d3.quantileSorted(v,0.50);
    const q3=d3.quantileSorted(v,0.75);
    const iqr=q3-q1;
    const low = Math.max(d3.min(v), q1-1.5*iqr);
    const high= Math.min(d3.max(v), q3+1.5*iqr);
    return {q1,q2,q3,low,high};
  }

  const grouped=d3.group(rows,d=>d.structure);
  const boxes=structures.map(sg=>{
    const vals=(grouped.get(sg)||[]).map(d=>d.logSig);
    return vals.length?{structure:sg,...boxStats(vals)}:null;
  }).filter(Boolean);

  const boxWidth = x.bandwidth()*0.5;
  const boxLayer = g.append("g");
  const whiskerLayer = g.append("g");
  const labelLayer = g.append("g");

  boxLayer.selectAll("rect.violin")
    .data(boxes)
    .join("rect")
      .attr("class","violin")
      .attr("x",d=>x(d.structure)+(x.bandwidth()-boxWidth)/2)
      .attr("width",boxWidth)
      .attr("y",d=>y(d.q3))
      .attr("height",d=>Math.max(1,y(d.q1)-y(d.q3)))
      .attr("fill", d => structureColors[d.structure] || "#ccc");

  whiskerLayer.selectAll("g.whisk")
    .data(boxes)
    .join("g")
      .attr("class","whisk")
      .each(function(d){
        const cx = x(d.structure)+x.bandwidth()/2;
        const bw = boxWidth;

        d3.select(this).append("line").attr("x1",cx).attr("x2",cx)
          .attr("y1",y(d.high)).attr("y2",y(d.q3)).attr("stroke","#222");
        d3.select(this).append("line").attr("x1",cx).attr("x2",cx)
          .attr("y1",y(d.low)).attr("y2",y(d.q1)).attr("stroke","#222");
        d3.select(this).append("line").attr("x1",cx-bw/2).attr("x2",cx+bw/2)
          .attr("y1",y(d.high)).attr("y2",y(d.high)).attr("stroke","#222");
        d3.select(this).append("line").attr("x1",cx-bw/2).attr("x2",cx+bw/2)
          .attr("y1",y(d.low)).attr("y2",y(d.low)).attr("stroke","#222");

        d3.select(this).append("line")
          .attr("class","median")
          .attr("x1",cx-bw/2).attr("x2",cx+bw/2)
          .attr("y1",y(d.q2)).attr("y2",y(d.q2));

        const medLinear = Math.pow(10,d.q2);
        const label = medLinear < 0.001 ? fmtSci(medLinear) : fmtFix4(medLinear);
        labelLayer.append("text").attr("class","label-halo").attr("x", cx).attr("y", y(d.q2) - 6)
          .attr("text-anchor", "middle").text(label);
        labelLayer.append("text").attr("class","median-text").attr("x", cx).attr("y", y(d.q2) - 6)
          .attr("text-anchor", "middle").text(label);
      });

  const structCenter=Object.fromEntries(structures.map(sg=>[sg,x(sg)+x.bandwidth()/2]));
  const dotHalf=x.bandwidth()/2*0.92;

  const colorIon = d3.scaleOrdinal()
    .domain(ions)
    .range(ions.map(t => ionColors[t] || "#6b7280"));

  let activeIons=new Set(ions);

  const pts=g.append("g").selectAll(".point").data(rows).join("circle")
    .attr("class","point")
    .attr("r",3)
    .attr("cx",d=>{
      const c=structCenter[d.structure];
      const key=`${d.structure}|${d.ion}|${d.sigma}|${d.logSig}`;
      return c+stableJitter(key,dotHalf);
    })
    .attr("cy",d=>y(d.logSig))
    .attr("fill",d=>colorIon(d.ion))
    .attr("display",d=>activeIons.has(d.ion)?null:"none");

  const legend=d3.select("#legend");
  const items=legend.selectAll(".legend-item").data(ions).enter().append("div").attr("class","legend-item");
  items.append("div").attr("class","legend-swatch").style("background",d=>colorIon(d));
  items.append("span").text(d=>d);

  function updatePoints(){ pts.attr("display",d=>activeIons.has(d.ion)?null:"none"); }
  items.on("click",function(_,ion){
    if(activeIons.has(ion)) activeIons.delete(ion); else activeIons.add(ion);
    d3.select(this).classed("disabled",!activeIons.has(ion));
    updatePoints();
  });
  d3.select("#showAll").on("click",()=>{activeIons=new Set(ions);items.classed("disabled",false);updatePoints();});
  d3.select("#hideAll").on("click",()=>{activeIons.clear();items.classed("disabled",true);updatePoints();});
});
</script>
</body>
</html>

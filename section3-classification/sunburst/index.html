<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Sunburst — 580 px Chart</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root { color-scheme: dark; }
    html, body { height:100%; margin:0; }
    body {
      font-family: system-ui, Segoe UI, Roboto, sans-serif;
      background:#0f1115; color:#e8e8ea;
      display:flex; flex-direction:column;
    }
    header {
      padding:10px 14px; background:#171a20;
      display:flex; gap:16px; align-items:center; flex-wrap:wrap;
      border-bottom:1px solid #262a32;
    }
    #wrap { flex:1; display:flex; padding:10px 12px; gap:12px; min-height:0; }
    #chartCard {
      flex:1;
      display:grid;
      grid-template-columns: minmax(560px, 1.4fr) 320px; /* wider chart */
      gap:12px; align-items:start; min-height:0;
    }
    .chartBody {
      background:#101626; border:1px dashed #333a49; border-radius:12px;
      position:relative;
      height:580px;              /* fixed 580px height */
      min-height:580px;
    }
    svg { width:100%; height:100%; display:block; }

    /* Legend */
    .legend {
      background:#0f141f; border:1px solid #2a3240; border-radius:12px;
      padding:10px; overflow:auto; max-height:calc(100vh - 150px);
    }
    .legend h4 { margin:0 0 8px 0; font-size:12px; color:#cbd5e1; letter-spacing:.4px; text-transform:uppercase; }
    .legendGroup { display:flex; flex-direction:column; gap:6px; }

    .ionRow {
      display:grid; grid-template-columns:18px 1fr 18px;
      gap:10px; align-items:center; padding:6px 8px;
      border-radius:8px; user-select:none; cursor:pointer;
    }
    .ionRow:hover { background:#0f1726; }
    .swatch { width:18px; height:18px; border-radius:4px; border:1px solid rgba(255,255,255,.35); }
    .chev { width:18px; text-align:center; color:#a9b3c8; }
    .sublist { margin-left:26px; display:none; }
    .sublist.open { display:block; }
    .structRow, .stratRow {
      display:grid; grid-template-columns:14px 1fr 18px;
      gap:8px; align-items:center; padding:4px 6px;
      border-radius:6px; cursor:pointer;
    }
    .structRow:hover, .stratRow:hover { background:#0c1322; }
    .smSwatch { width:14px; height:14px; border-radius:3px; border:1px solid rgba(255,255,255,.28); }
    .tooltip {
      position:fixed; pointer-events:none; background:rgba(0,0,0,.9);
      color:#fff; padding:8px 10px; border-radius:8px; font-size:12px; line-height:1.3;
      display:none; z-index:10; box-shadow:0 6px 18px rgba(0,0,0,.45);
    }
    .dimmed { opacity:.18; transition:opacity .15s ease; }
    .highlight { opacity:1; transition:opacity .15s ease; }
  </style>
</head>
<body>
  <header>
    <strong>Sunburst (580 px Fixed)</strong>
    <span id="rtStats" style="font-size:12px;color:#9fb3cc;"></span>
  </header>

  <div id="wrap">
    <div id="chartCard">
      <div id="chart" class="chartBody"></div>
      <div id="legend" class="legend">
        <h4>Legend</h4>
        <div class="legendGroup"></div>
      </div>
    </div>
  </div>

  <div id="tooltip" class="tooltip"></div>

  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script>
    const DEF_COND = 1e-6;
    const SCALE_MODE = 'log';
    let root, svgGlobal, gArcs, colorIon;
    const selIons = new Set(), selStructs = new Set(), selStrats = new Set();
    let hoverKey = null;

    document.addEventListener('DOMContentLoaded', async () => {
      const dataObj = await (await fetch('data.simplified.json', {cache: 'no-store'})).json();
      draw(dataObj);
      window.addEventListener('resize', () => requestAnimationFrame(() => draw(dataObj)));
    });

    function obj2children(obj){
      return Object.entries(obj).map(([ion, structures]) => ({
        name: ion,
        children: Object.entries(structures || {}).map(([structure, strategies]) => ({
          name: structure,
          children: Object.entries(strategies || {}).map(([strategy, formulas]) => ({
            name: strategy,
            children: Object.entries(formulas || {}).map(([formula, vals]) => {
              const nums = Array.isArray(vals) ? vals.map(Number).filter(x => Number.isFinite(x) && x>0) : [];
              return { name: formula, values: nums };
            })
          }))
        }))
      }));
    }

    function computeLeafCond(h, def){
      h.each(n=>{
        if (n.data && Array.isArray(n.data.values)) {
          const vals = n.data.values.filter(Number.isFinite);
          if (vals.length) { n.data.cond = vals[0]; n.data.hasCond = true; }
          else { n.data.cond = def; n.data.hasCond = false; }
        }
      });
    }

    function draw(dataObj){
      const chartEl = document.getElementById('chart');
      const legendEl = document.querySelector('.legendGroup');
      const tooltip = document.getElementById('tooltip');
      chartEl.innerHTML = ''; legendEl.innerHTML = '';

      const rect = chartEl.getBoundingClientRect();
      const side = Math.min(rect.width, rect.height);
      const data = { name:'root', children: obj2children(dataObj) };
      root = d3.hierarchy(data, d=>d.children).sum(d=>Array.isArray(d?.values)?1:0);

      const ringThickness = Math.max(50, side*0.09);
      computeLeafCond(root, DEF_COND);
      d3.partition().size([2*Math.PI, (root.height+1)*ringThickness])(root);

      const leaves = root.leaves();
      const condVals = leaves.map(l=>l.data.cond||DEF_COND);
      const [cmin,cmax] = d3.extent(condVals);
      const condScale = d3.scaleLog().domain([Math.max(cmin,1e-12),Math.max(cmax,1e-12)]).range([0,side*0.22]);

      const ions = (root.children||[]).map(d=>d.data.name);
      colorIon = d3.scaleOrdinal(ions, d3.quantize(t=>d3.interpolateRainbow(t),Math.max(3,ions.length)));

      const outerRadiusFor = d=>d.children?d.y1:d.y1+20+condScale(d.data.cond||DEF_COND);
      const svg = d3.select(chartEl).append('svg')
        .attr('width','100%').attr('height','100%')
        .attr('viewBox',`${-side/2} ${-side/2} ${side} ${side}`);
      const g = svg.append('g');
      gArcs = g;

      const arc = d3.arc()
        .startAngle(d=>d.x0).endAngle(d=>d.x1)
        .innerRadius(d=>d.y0).outerRadius(d=>outerRadiusFor(d))
        .padAngle(0.003).padRadius(side*0.4);

      const paths = g.selectAll('path').data(root.descendants().filter(d=>d.depth>0))
        .join('path').attr('d',arc)
        .attr('fill',d=>{
          let ion=d; while(ion.depth>1) ion=ion.parent;
          const c=colorIon(ion.data.name);
          if(!d.children && !d.data.hasCond){const cc=d3.color(c);cc.opacity=0.5;return cc;}
          return c;
        })
        .attr('stroke','#fff').attr('stroke-opacity',0.3);

      paths.on('mousemove',(evt,d)=>{
        tooltip.style.display='block';
        tooltip.innerHTML=`<strong>${d.ancestors().reverse().slice(1).map(n=>n.data.name).join(' → ')}</strong><br/>
        σ: ${d.data.cond.toExponential(2)} S/cm`;
        tooltip.style.left=(evt.clientX+10)+'px'; tooltip.style.top=(evt.clientY+10)+'px';
      }).on('mouseleave',()=>tooltip.style.display='none');

      buildLegendTree(legendEl);
    }

    function buildLegendTree(container){
      container.innerHTML='';
      (root.children||[]).forEach(ionNode=>{
        const ion=ionNode.data.name;
        const ionRow=document.createElement('div');
        ionRow.className='ionRow';
        const sw=document.createElement('div');sw.className='swatch';sw.style.background=colorIon(ion);
        const nm=document.createElement('div');nm.textContent=ion;
        const cv=document.createElement('div');cv.className='chev';cv.textContent='▸';
        ionRow.append(sw,nm,cv);container.appendChild(ionRow);
        const subStruct=document.createElement('div');subStruct.className='sublist';container.appendChild(subStruct);
        ionRow.onclick=()=>{subStruct.classList.toggle('open');cv.textContent=subStruct.classList.contains('open')?'▾':'▸';};
        (ionNode.children||[]).forEach(structNode=>{
          const struct=structNode.data.name;
          const srow=document.createElement('div');
          srow.className='structRow';
          const sm=document.createElement('div');sm.className='smSwatch';sm.style.background=d3.color(colorIon(ion)).brighter(0.8);
          const sn=document.createElement('div');sn.textContent=struct;
          srow.append(sm,sn);subStruct.appendChild(srow);
        });
      });
    }
  </script>
</body>
</html>

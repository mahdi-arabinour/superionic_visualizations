<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Sunburst â€” Interactive Legend + Compact Layout</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root { color-scheme: dark; }
    body {
      margin:0;
      font-family:system-ui,Segoe UI,Roboto,sans-serif;
      background:#0f1115;
      color:#e8e8ea;
      height:100vh;
      display:flex;
      flex-direction:column;
    }
    header {
      padding:10px 14px;
      background:#171a20;
      display:flex;
      gap:16px;
      flex-wrap:wrap;
      align-items:center;
      border-bottom:1px solid #262a32;
    }
    #wrap { flex:1; display:flex; padding:10px 12px; gap:12px; }
    #chartCard {
      flex:1;
      display:grid;
      grid-template-columns: minmax(420px, 1fr) 320px;
      gap:12px;
      align-items:start;
    }
    .chartBody {
      background:#101626;
      border:1px dashed #333a49;
      border-radius:12px;
      position:relative;
      height:min(420px, 60vh); /* Smaller responsive chart */
    }
    svg { width:100%; height:100%; display:block; }

    /* Legend */
    .legend {
      background:#0f141f;
      border:1px solid #2a3240;
      border-radius:12px;
      padding:10px;
      overflow:auto;
      max-height:calc(100vh - 150px);
    }
    .legend h4 {
      margin:0 0 8px 0;
      font-size:12px;
      color:#cbd5e1;
      letter-spacing:.4px;
      text-transform:uppercase;
    }
    .legendGroup { display:flex; flex-direction:column; gap:6px; }

    .ionRow {
      display:grid;
      grid-template-columns: 18px 1fr 18px;
      gap:10px;
      align-items:center;
      padding:6px 8px;
      border-radius:8px;
      user-select:none;
      cursor:pointer;
    }
    .ionRow:hover { background:#0f1726; }
    .swatch { width:18px; height:18px; border-radius:4px; border:1px solid rgba(255,255,255,.35); }
    .ionName { }
    .chev { width:18px; text-align:center; color:#a9b3c8; }

    .sublist { margin-left:26px; display:none; }
    .sublist.open { display:block; }

    .structRow, .stratRow {
      display:grid;
      grid-template-columns:14px 1fr 18px;
      gap:8px;
      align-items:center;
      padding:4px 6px;
      border-radius:6px;
      cursor:pointer;
    }
    .structRow:hover, .stratRow:hover { background:#0c1322; }
    .smSwatch { width:14px; height:14px; border-radius:3px; border:1px solid rgba(255,255,255,.28); }
    .chevSm { width:18px; text-align:center; color:#8fa0b8; }

    .tooltip {
      position:fixed;
      pointer-events:none;
      background:rgba(0,0,0,.9);
      color:#fff;
      padding:8px 10px;
      border-radius:8px;
      font-size:12px;
      line-height:1.3;
      display:none;
      z-index:10;
      box-shadow:0 6px 18px rgba(0,0,0,.45);
    }
    .dimmed { opacity:.18; transition:opacity .15s ease; }
    .highlight { opacity:1; transition:opacity .15s ease; }
  </style>
</head>
<body>
  <header>
    <strong>Sunburst (Interactive Legend)</strong>
    <span id="rtStats" style="font-size:12px;color:#9fb3cc;"></span>
  </header>

  <div id="wrap">
    <div id="chartCard">
      <div id="chart" class="chartBody"></div>
      <div id="legend" class="legend">
        <h4>Legend</h4>
        <div class="legendGroup"></div>
      </div>
    </div>
  </div>

  <div id="tooltip" class="tooltip"></div>

  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script>
    const DEF_COND = 1e-6;
    const SCALE_MODE = 'log';
    let root, svgGlobal, gArcs, colorIon;
    co

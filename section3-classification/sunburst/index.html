<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Sunburst — Labels Toggle</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<style>
:root { color-scheme: dark; }
html,body{height:100%;margin:0}
body{
  font-family:system-ui,Segoe UI,Roboto,sans-serif;
  background:#0f1115;color:#e8e8ea;
  display:flex;flex-direction:column
}
header{
  padding:10px 14px;background:#171a20;
  display:flex;gap:16px;align-items:center;flex-wrap:wrap;
  border-bottom:1px solid #262a32
}
#wrap{flex:1;display:flex;padding:10px 12px;gap:12px;min-height:0}
#chartCard{
  flex:1;display:grid;
  grid-template-columns:minmax(640px,1.6fr) 300px;
  gap:12px;align-items:start;min-height:0
}
.chartBody{
  background:#101626;border:1px dashed #333a49;border-radius:12px;
  position:relative;height:min(88vh,900px);min-height:520px
}
svg{width:100%;height:100%;display:block}
.legend{
  background:#0f141f;border:1px solid #2a3240;border-radius:12px;
  padding:10px;overflow:auto;max-height:calc(100vh - 150px)
}
.legend h4{margin:0 0 8px 0;font-size:12px;color:#cbd5e1;text-transform:uppercase}
.legendGroup{display:flex;flex-direction:column;gap:6px}
.tooltip{
  position:fixed;pointer-events:none;background:rgba(0,0,0,.9);
  color:#fff;padding:8px 10px;border-radius:8px;font-size:12px;
  display:none;z-index:10;box-shadow:0 6px 18px rgba(0,0,0,.45)
}
.label{font-size:8px;fill:#eee;text-anchor:middle;pointer-events:none}
.hiddenLabel{opacity:0;transition:opacity .3s}
.visibleLabel{opacity:1;transition:opacity .3s}
</style>
</head>
<body>
<header>
  <strong>Sunburst (Toggle Labels)</strong>
  <label style="font-size:13px;">
    <input type="checkbox" id="labelToggle" checked>
    Show Labels
  </label>
</header>
<div id="wrap">
  <div id="chartCard">
    <div id="chart" class="chartBody"></div>
    <div id="legend" class="legend"><h4>Legend</h4><div class="legendGroup"></div></div>
  </div>
</div>
<div id="tooltip" class="tooltip"></div>
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<script>
const DEF_COND=1e-6;
let root,gArcs,colorIon,labelsVisible=true;

document.addEventListener('DOMContentLoaded',async()=>{
  const dataObj=await (await fetch('data.simplified.json',{cache:'no-store'})).json();
  draw(dataObj);
  document.getElementById('labelToggle').addEventListener('change',e=>{
    labelsVisible=e.target.checked;
    toggleLabels();
  });
});

function obj2children(obj){
  return Object.entries(obj).map(([ion,structures])=>({
    name:ion,children:Object.entries(structures||{}).map(([structure,strategies])=>({
      name:structure,children:Object.entries(strategies||{}).map(([strategy,formulas])=>({
        name:strategy,children:Object.entries(formulas||{}).map(([formula,vals])=>{
          const nums=Array.isArray(vals)?vals.map(Number).filter(x=>Number.isFinite(x)&&x>0):[];
          return{name:formula,values:nums};
        })
      }))
    }))
  }));
}

function computeLeafCond(h,def){
  h.each(n=>{
    if(n.data&&Array.isArray(n.data.values)){
      const vals=n.data.values.filter(Number.isFinite);
      n.data.cond=vals.length?vals[0]:def;
      n.data.hasCond=vals.length>0;
    }
  });
}

function draw(dataObj){
  const chartEl=document.getElementById('chart');
  chartEl.innerHTML='';
  const rect=chartEl.getBoundingClientRect();
  const size=Math.min(rect.width,rect.height);
  const data={name:'root',children:obj2children(dataObj)};
  root=d3.hierarchy(data,d=>d.children).sum(d=>Array.isArray(d?.values)?1:0);
  computeLeafCond(root,DEF_COND);
  d3.partition().size([2*Math.PI,size/2])(root);

  const ions=(root.children||[]).map(d=>d.data.name);
  colorIon=d3.scaleOrdinal(ions,d3.quantize(t=>d3.interpolateRainbow(t),ions.length));

  const arc=d3.arc().startAngle(d=>d.x0).endAngle(d=>d.x1)
    .innerRadius(d=>d.y0).outerRadius(d=>d.y1);
  const svg=d3.select(chartEl).append('svg')
    .attr('width','100%').attr('height','100%')
    .attr('viewBox',`${-size/2} ${-size/2} ${size} ${size}`);
  const g=svg.append('g');
  gArcs=g;

  g.selectAll('path')
    .data(root.descendants().filter(d=>d.depth))
    .join('path')
    .attr('d',arc)
    .attr('fill',d=>{
      let ion=d;while(ion.depth>1)ion=ion.parent;
      const c=colorIon(ion.data.name);
      return c;
    })
    .attr('stroke','#fff').attr('stroke-opacity',0.2);

  // labels
  g.selectAll('text')
    .data(root.descendants().filter(d=>d.depth>0))
    .join('text')
    .attr('class','label visibleLabel')
    .attr('transform',d=>{
      const x=(d.x0+d.x1)/2*180/Math.PI;
      const y=(d.y0+d.y1)/2;
      return`rotate(${x-90}) translate(${y},0) rotate(${x<180?0:180})`;
    })
    .text(d=>d.data.name.length>18?d.data.name.slice(0,18)+'…':d.data.name);
}

function toggleLabels(){
  d3.selectAll('.label')
    .attr('class',labelsVisible?'label visibleLabel':'label hiddenLabel');
}
</script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Beeswarm — σ vs Doping_Subtype (color by Structure)</title>
<script src="https://d3js.org/d3.v7.min.js"></script>
<style>
  :root { color-scheme: light; }
  body { margin: 16px; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial; background:#f7f7f7; color:#0f172a; }
  h2 { margin: 0 0 8px; font-size: 22px; }
  .sub { margin: 0 0 16px; font-size: 12px; color:#475569; }
  .wrap { display: flex; align-items: flex-start; gap: 16px; }
  #chartPane { flex: 1 1 auto; min-width: 0; }
  svg { width: 100%; height: auto; background:#fff; border:1px solid #e5e7eb; border-radius: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.04); }
  .axis path, .axis line { stroke:#cbd5e1; }
  .axis text { fill:#334155; font-size:12px; }
  .rowLabel { fill:#111827; font-weight:600; font-size:12px; }
  .tooltip { position: fixed; pointer-events: none; background:#fff; border:1px solid #e5e7eb; box-shadow:0 8px 16px rgba(0,0,0,.08); border-radius:8px; padding:8px 10px; font-size:12px; color:#111827; }
  .legendCol { flex: 0 0 280px; position: sticky; top: 12px; display:flex; flex-direction: column; gap: 12px; }
  .card { background:#fff; border:1px solid #e5e7eb; border-radius: 12px; padding: 10px 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.04); }
  .card h3 { margin: 0 0 8px; font-size: 13px; color:#111827; display:flex; align-items:center; justify-content:space-between; gap:8px; }
  .legend-list { display:flex; flex-direction: column; gap:4px; max-height: 66vh; overflow:auto; }
  .legend-item { display:flex; align-items:center; gap:8px; font-size:12px; padding:6px 8px; border-radius:8px; cursor:pointer; user-select:none; }
  .legend-item:hover { background:#f3f4f6; }
  .legend-item.inactive { opacity:0.45; }
  .legend-swatch { width:16px; height:16px; border-radius:4px; border:1px solid rgba(0,0,0,0.35); }
  .legend-row { display:flex; gap:8px; margin-bottom:8px; }
  .btn { border:1px solid #e5e7eb; background:#fff; border-radius:999px; padding:4px 8px; cursor:pointer; font-size:12px; color:#374151; }
  .btn:hover { background:#f3f4f6; }
  @media (max-width: 980px) { .wrap { flex-direction: column; } .legendCol { position: static; width: 100%; } }
</style>
</head>
<body>

<h2>σ (S/cm) vs Doping_Subtype — colored by Structure Group</h2>
<div class="sub">One point per row in your data. X = log₁₀(σ). Y = Doping_Subtype. Color = Structure Group. Tooltip includes <i>Doping / and or GB Strategy</i>.</div>

<div class="wrap">
  <div id="chartPane">
    <svg id="chart" viewBox="0 0 1200 760" preserveAspectRatio="xMidYMid meet"></svg>
  </div>

  <aside class="legendCol">
    <div class="card">
      <h3>Structure Group (Color)</h3>
      <div class="legend-row">
        <button id="structSelectAll" class="btn">Select All</button>
        <button id="structClearAll"  class="btn">Clear</button>
      </div>
      <div id="structItems" class="legend-list"></div>
    </div>
  </aside>
</div>

<script>
/* ----- Column names (exact) ----- */
const COL_SIGMA    = "Conductivity σ (S/cm)";
const COL_STRUCT   = "Structure Group";
const COL_DOPANT   = "Doping / and or GB Strategy";
const COL_SUBTYPE  = "Doping_Subtype";

/* ----- Structure color palette (yours) ----- */
const STRUCT_COLORS = {
  "Others":"#9e9e9e","Polymeric":"#ff7043","Argyrodite":"#ab47bc","Halide":"#26a69a",
  "Amorphous":"#f6bf26","NASICON":"#66bb6a","Anti-perovskite":"#0d47a1","Spinel":"#8d6e63"
};
const structColor = s => STRUCT_COLORS[s] || "#9ca3af";

/* ----- Layout ----- */
const margin = {top: 36, right: 20, bottom: 64, left: 180};
const W = 1200 - margin.left - margin.right;
const H = 760  - margin.top  - margin.bottom;

const svg = d3.select("#chart");
const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);
const xAxisG = g.append("g").attr("class","axis").attr("transform", `translate(0,${H})`);
const yAxisG = g.append("g");
g.append("text").attr("x", W/2).attr("y", H+44).attr("text-anchor","middle")
  .attr("fill","#111827").attr("font-size",13).text("Conductivity σ (S·cm⁻¹) — log scale");

const tooltip = d3.select("body").append("div").attr("class","tooltip").style("opacity",0);

/* ----- State ----- */
let data = [];
let subtypes = [];
let structures = [];
let activeStructures = new Set();
let x, y;

d3.csv("data.csv").then(raw => {
  // Tidy & filter
  data = raw.map(d => ({
    sigma:     +d[COL_SIGMA],
    structure: (d[COL_STRUCT]   || "").trim(),
    dopant:    (d[COL_DOPANT]   || "").trim(),
    subtype:   (d[COL_SUBTYPE]  || "").trim(),
    _raw: d
  })).filter(d => Number.isFinite(d.sigma) && d.sigma > 0 && d.structure && d.subtype);

  // Domains
  subtypes   = Array.from(new Set(data.map(d => d.subtype))).sort();
  structures = Array.from(new Set(data.map(d => d.structure))).sort();
  activeStructures = new Set(structures);

  // Scales
  x = d3.scaleLog()
        .domain(d3.extent(data, d => d.sigma))
        .nice()
        .range([0, W]);

  const band = d3.scaleBand().domain(subtypes).range([0, H]).paddingInner(0.2);
  const rowCenter = s => (band(s) ?? 0) + band.bandwidth()/2;
  y = s => rowCenter(s);

  // Axes
  xAxisG.call(d3.axisBottom(x).ticks(10, "~g"));
  yAxisG.selectAll(".rowLabel")
    .data(subtypes)
    .join("text")
      .attr("class","rowLabel")
      .attr("x", -12)
      .attr("y", s => y(s))
      .attr("dy", 5)
      .attr("text-anchor", "end")
      .text(s => s);

  // Build legend
  buildStructureLegend();

  // Draw
  draw();

}).catch(() => {
  d3.select("#chartPane").append("div")
    .style("margin","12px 8px").style("color","#b91c1c")
    .text("⚠️ Could not load data.csv. Please open via a local web server (e.g., python3 -m http.server).");
});

function draw(){
  // Filter by active structures
  const rows = data.filter(d => activeStructures.has(d.structure));

  // Beeswarm per subtype row (jitter vertically, collide, target x = log σ)
  const jitterY = 10;
  const baseR   = 4; // radius (constant; you can map r to something else if you want)
  const all = [];

  const bySubtype = d3.group(rows, d => d.subtype);
  for (const [subtype, arr] of bySubtype.entries()){
    const y0 = y(subtype);
    // Seed nodes near targets
    const rowNodes = arr.map(d => ({
      ...d,
      targetX: x(d.sigma),
      targetY: y0,
      x: x(d.sigma) + (Math.random()*2-1)*2,
      y: y0 + (Math.random()*2-1)*jitterY,
      r: baseR
    }));
    // Force layout: pack horizontally around x(sigma), keep near row center, avoid overlaps
    const sim = d3.forceSimulation(rowNodes)
      .force("x", d3.forceX(n => n.targetX).strength(0.5))
      .force("y", d3.forceY(n => n.targetY).strength(0.15))
      .force("collide", d3.forceCollide(n => n.r + 0.8))
      .stop();
    for (let i=0;i<160;i++) sim.tick();
    all.push(...rowNodes);
  }

  const dots = g.selectAll("circle.dot")
    .data(all, d => d.structure + "\u0001" + d.subtype + "\u0001" + d.dopant + "\u0001" + d.sigma)
    .join(
      enter => enter.append("circle")
        .attr("class","dot")
        .attr("r", d => d.r)
        .attr("cx", d => d.x)
        .attr("cy", d => d.y)
        .attr("fill", d => structColor(d.structure))
        .attr("stroke","rgba(17,24,39,0.85)")
        .attr("stroke-width", 0.6)
        .attr("opacity", 0.96)
        .on("mouseover",(event,d)=>{
          tooltip.style("opacity",1).html(`
            <div><b>σ:</b> ${formatSig(d.sigma)} S/cm</div>
            <div><b>Structure:</b> ${d.structure}</div>
            <div><b>Doping_Subtype:</b> ${d.subtype || "—"}</div>
            <div><b>Doping / and or GB Strategy:</b> ${d.dopant || "—"}</div>
          `);
        })
        .on("mousemove",(event)=>{ tooltip.style("left",(event.clientX+14)+"px").style("top",(event.clientY+14)+"px"); })
        .on("mouseout",()=> tooltip.style("opacity",0)),
      update => update
        .attr("cx", d => d.x)
        .attr("cy", d => d.y)
        .attr("fill", d => structColor(d.structure))
    );
}

/* ---------- Structure legend (filterable) ---------- */
function buildStructureLegend(){
  const container = d3.select("#structItems");
  container.selectAll("*").remove();

  structures.forEach(name => {
    const item = container.append("div").attr("class","legend-item");
    item.on("click", (ev) => {
      const solo = activeStructures.size === 1 && activeStructures.has(name);
      if (ev.metaKey || ev.ctrlKey) {
        // toggle
        activeStructures.has(name) ? activeStructures.delete(name) : activeStructures.add(name);
      } else if (ev.shiftKey) {
        // add
        activeStructures.add(name);
      } else {
        // solo; click again to reset all
        activeStructures = solo ? new Set(structures) : new Set([name]);
      }
      refreshStructLegend();
      draw();
    });
    item.append("div").attr("class","legend-swatch").style("background", structColor(name));
    item.append("span").text(name);
  });

  d3.select("#structSelectAll").on("click", () => {
    activeStructures = new Set(structures);
    refreshStructLegend(); draw();
  });
  d3.select("#structClearAll").on("click", () => {
    activeStructures = new Set();
    refreshStructLegend(); draw();
  });

  refreshStructLegend();
}
function refreshStructLegend(){
  d3.selectAll("#structItems .legend-item").classed("inactive", function(){
    const name = d3.select(this).select("span").text();
    return !activeStructures.has(name);
  });
}

/* ---------- utils ---------- */
function formatSig(v){
  if (!Number.isFinite(v)) return "–";
  const e = Math.log10(v);
  return (e >= -2 && e <= 3) ? v.toPrecision(3) : `1e${e.toFixed(1)}`;
}
</script>
</body>
</html>

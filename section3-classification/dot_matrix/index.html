<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>σ vs Doping Type — right legend + checkbox subtype filter</title>
<script src="https://d3js.org/d3.v7.min.js"></script>
<style>
  :root { color-scheme: light; }
  body { margin:16px; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial; background:#f7f7f7; color:#0f172a; }
  h2 { margin:0 0 8px; font-size:22px; }
  .sub { margin:0 0 12px; font-size:12px; color:#475569; }
  .wrap { display:flex; align-items:flex-start; gap:16px; }
  #chartPane { flex:1 1 auto; min-width:0; }
  svg { width:100%; height:auto; background:#fff; border:1px solid #e5e7eb; border-radius:12px; box-shadow:0 1px 2px rgba(0,0,0,0.04); }
  .axis path, .axis line { stroke:#cbd5e1; }
  .axis text { fill:#334155; font-size:12px; }
  .rowLabel { fill:#111827; font-weight:600; font-size:12px; }
  .tooltip { position:fixed; pointer-events:none; background:#fff; border:1px solid #e5e7eb; box-shadow:0 8px 16px rgba(0,0,0,.08); border-radius:8px; padding:8px 10px; font-size:12px; color:#111827; }
  .legendCol { flex:0 0 340px; position:sticky; top:12px; display:flex; flex-direction:column; gap:12px; }
  .card { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:10px 12px; box-shadow:0 1px 2px rgba(0,0,0,0.04); }
  .card h3 { margin:0 0 8px; font-size:13px; color:#111827; display:flex; align-items:center; justify-content:space-between; gap:8px; }
  .legend-list { display:flex; flex-direction:column; gap:4px; max-height:34vh; overflow:auto; }
  .legend-item { display:flex; align-items:center; gap:8px; font-size:12px; padding:6px 8px; border-radius:8px; cursor:pointer; user-select:none; }
  .legend-item:hover { background:#f3f4f6; }
  .legend-item.inactive { opacity:0.45; }
  .legend-swatch { width:16px; height:16px; border-radius:4px; border:1px solid rgba(0,0,0,0.35); }
  .legend-row { display:flex; gap:8px; margin-bottom:8px; }
  .btn { border:1px solid #e5e7eb; background:#fff; border-radius:999px; padding:4px 8px; cursor:pointer; font-size:12px; color:#374151; }
  .btn:hover { background:#f3f4f6; }

  /* top control: bubble size */
  .controls { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin:0 0 10px; }
  .ctl { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:8px 10px; font-size:12px; display:flex; align-items:center; gap:8px; }

  /* subtype checklist */
  .checklist { display:flex; flex-direction:column; gap:6px; max-height:34vh; overflow:auto; border:1px solid #e5e7eb; border-radius:10px; padding:8px; }
  .check-item { display:flex; align-items:center; gap:10px; font-size:12px; }
  .check-item input { width:14px; height:14px; }
  @media (max-width:980px){ .wrap{flex-direction:column;} .legendCol{position:static;width:100%;} }
</style>
</head>
<body>

<h2>σ (S/cm) vs Doping Type — colored by Structure Group</h2>
<div class="sub">X = log₁₀(σ). Y = Doping Type. Color = Structure Group. Use the right-side legend and checkboxes to filter; adjust bubble size above.</div>

<!-- top control: bubble size -->
<div class="controls">
  <div class="ctl">
    <label for="sizeSlider"><b>Bubble size</b></label>
    <input id="sizeSlider" type="range" min="0.6" max="2.0" step="0.05" value="1.0">
    <span id="sizeVal">1.00×</span>
    <button id="sizeReset" class="btn">Reset</button>
  </div>
</div>

<div class="wrap">
  <div id="chartPane">
    <svg id="chart" viewBox="0 0 1200 760" preserveAspectRatio="xMidYMid meet"></svg>
  </div>

  <aside class="legendCol">
    <!-- Structure legend -->
    <div class="card">
      <h3>Structure Group (Color)</h3>
      <div class="legend-row">
        <button id="structSelectAll" class="btn">Select All</button>
        <button id="structClearAll"  class="btn">Clear</button>
      </div>
      <div id="structItems" class="legend-list"></div>
    </div>

    <!-- Doping_Subtype checklist -->
    <div class="card">
      <h3>Doping_Subtype</h3>
      <div id="subtypeList" class="checklist" role="group" aria-label="Doping subtypes"></div>
      <div class="legend-row" style="margin-top:8px;">
        <button id="subtypeAll" class="btn">Select All</button>
        <button id="subtypeClear" class="btn">Clear</button>
      </div>
    </div>
  </aside>
</div>

<script>
/* Columns */
const COL_SIGMA    = "Conductivity σ (S/cm)";
const COL_STRUCT   = "Structure Group";
const COL_DOPANT   = "Doping / and or GB Strategy";
const COL_SUBTYPE  = "Doping_Subtype";

/* Structure palette */
const STRUCT_COLORS = {
  "Others":"#9e9e9e","Polymeric":"#ff7043","Argyrodite":"#ab47bc","Halide":"#26a69a",
  "Amorphous":"#f6bf26","NASICON":"#66bb6a","Anti-perovskite":"#0d47a1","Spinel":"#8d6e63"
};
const structColor = s => STRUCT_COLORS[s] || "#9ca3af";

/* Layout */
const margin = {top:36,right:20,bottom:64,left:200};
const W = 1200 - margin.left - margin.right;
const H = 760  - margin.top  - margin.bottom;

const svg = d3.select("#chart");
const g = svg.append("g").attr("transform",`translate(${margin.left},${margin.top})`);
const xAxisG = g.append("g").attr("class","axis").attr("transform",`translate(0,${H})`);
const yAxisG = g.append("g");
g.append("text").attr("x", W/2).attr("y", H+44).attr("text-anchor","middle")
  .attr("fill","#111827").attr("font-size",13).text("Conductivity σ (S·cm⁻¹) — log scale");
g.append("text").attr("x",-H/2).attr("y",-margin.left+60).attr("text-anchor","middle")
  .attr("fill","#111827").attr("font-size",13).attr("transform","rotate(-90)").text("Doping Type");

const tooltip = d3.select("body").append("div").attr("class","tooltip").style("opacity",0);

/* State */
let data=[], allSubtypes=[], structures=[];
let activeStructures=new Set(), activeSubtypes=new Set();
let x, band, yCenter;
let sizeFactor=1.0;

/* Controls */
const sizeSlider = document.getElementById("sizeSlider");
const sizeVal = document.getElementById("sizeVal");
const sizeReset = document.getElementById("sizeReset");
const subtypeList = document.getElementById("subtypeList");

d3.csv("data.csv").then(raw=>{
  data = raw.map(d=>({
    sigma:+d[COL_SIGMA],
    structure:(d[COL_STRUCT]||"").trim(),
    dopant:(d[COL_DOPANT]||"").trim(),
    subtype:(d[COL_SUBTYPE]||"").trim(),
  })).filter(d=>d.sigma>0 && d.structure && d.subtype);

  allSubtypes = Array.from(new Set(data.map(d=>d.subtype))).sort();
  structures  = Array.from(new Set(data.map(d=>d.structure))).sort();
  activeStructures = new Set(structures);
  activeSubtypes   = new Set(allSubtypes); // all checked by default

  // Build subtype checklist
  buildSubtypeChecklist();

  // Scales
  x = d3.scaleLog().domain(d3.extent(data,d=>d.sigma)).nice().range([0,W]);
  band = d3.scaleBand().domain(allSubtypes).range([0,H]).paddingInner(0.2);
  yCenter = s => (band(s)||0) + band.bandwidth()/2;
  xAxisG.call(d3.axisBottom(x).ticks(10,"~g"));

  // UI
  buildStructureLegend();
  wireSizeControl();

  draw();
}).catch(()=>{
  d3.select("#chartPane").append("div")
    .style("margin","12px 8px").style("color","#b91c1c")
    .text("⚠️ Could not load data.csv. Please open via a local web server (e.g., python3 -m http.server).");
});

function draw(){
  const rows = data.filter(d=>activeStructures.has(d.structure) && activeSubtypes.has(d.subtype));

  const visibleSubtypes = Array.from(activeSubtypes);
  band.domain(visibleSubtypes);
  yAxisG.selectAll(".rowLabel")
    .data(visibleSubtypes, d=>d)
    .join(
      enter=>enter.append("text").attr("class","rowLabel")
        .attr("x",-12).attr("y",s=>yCenter(s)).attr("dy",5)
        .attr("text-anchor","end").text(s=>s),
      update=>update.attr("y",s=>yCenter(s)),
      exit=>exit.remove()
    );

  const jitterY=10, baseR=4*sizeFactor;
  const all=[];
  const bySubtype=d3.group(rows,d=>d.subtype);
  for(const [subtype,arr] of bySubtype.entries()){
    const y0=yCenter(subtype);
    const nodes=arr.map(d=>({
      ...d,
      targetX:x(d.sigma), targetY:y0,
      x:x(d.sigma)+(Math.random()*2-1)*2,
      y:y0+(Math.random()*2-1)*jitterY,
      r:baseR
    }));
    const sim=d3.forceSimulation(nodes)
      .force("x", d3.forceX(n=>n.targetX).strength(0.5))
      .force("y", d3.forceY(n=>n.targetY).strength(0.15))
      .force("collide", d3.forceCollide(n=>n.r+0.8))
      .stop();
    for(let i=0;i<160;i++) sim.tick();
    all.push(...nodes);
  }

  g.selectAll("circle.dot")
    .data(all, d=>d.structure+"\u0001"+d.subtype+"\u0001"+d.dopant+"\u0001"+d.sigma)
    .join(
      enter=>enter.append("circle").attr("class","dot")
        .attr("r",d=>d.r).attr("cx",d=>d.x).attr("cy",d=>d.y)
        .attr("fill",d=>structColor(d.structure))
        .attr("stroke","rgba(17,24,39,0.85)").attr("stroke-width",0.6)
        .attr("opacity",0.96)
        .on("mouseover",(event,d)=>{
          tooltip.style("opacity",1).html(`
            <div><b>σ:</b> ${formatSig(d.sigma)} S/cm</div>
            <div><b>Structure:</b> ${d.structure}</div>
            <div><b>Doping Type:</b> ${d.subtype}</div>
            <div><b>Doping / and or GB Strategy:</b> ${d.dopant||"—"}</div>
          `);
        })
        .on("mousemove",(event)=>tooltip.style("left",(event.clientX+14)+"px").style("top",(event.clientY+14)+"px"))
        .on("mouseout",()=>tooltip.style("opacity",0)),
      update=>update.attr("r",d=>d.r).attr("cx",d=>d.x).attr("cy",d=>d.y),
      exit=>exit.remove()
    );
}

/* Structure legend (click to filter) */
function buildStructureLegend(){
  const container=d3.select("#structItems");
  container.selectAll("*").remove();
  structures.forEach(name=>{
    const item=container.append("div").attr("class","legend-item");
    item.on("click",(ev)=>{
      const solo=activeStructures.size===1&&activeStructures.has(name);
      if(ev.metaKey||ev.ctrlKey){
        activeStructures.has(name)?activeStructures.delete(name):activeStructures.add(name);
      }else if(ev.shiftKey){
        activeStructures.add(name);
      }else{
        activeStructures = solo ? new Set(structures) : new Set([name]);
      }
      refreshStructLegend(); draw();
    });
    item.append("div").attr("class","legend-swatch").style("background",structColor(name));
    item.append("span").text(name);
  });
  d3.select("#structSelectAll").on("click",()=>{activeStructures=new Set(structures);refreshStructLegend();draw();});
  d3.select("#structClearAll").on("click",()=>{activeStructures=new Set();refreshStructLegend();draw();});
  refreshStructLegend();
}
function refreshStructLegend(){
  d3.selectAll("#structItems .legend-item").classed("inactive",function(){
    const name=d3.select(this).select("span").text();
    return !activeStructures.has(name);
  });
}

/* Subtype checklist */
function buildSubtypeChecklist(){
  subtypeList.innerHTML = "";
  for(const s of allSubtypes){
    const id = "chk_"+s.replace(/\W+/g,"_");
    const row = document.createElement("label");
    row.className = "check-item";
    row.htmlFor = id;
    row.innerHTML = `
      <input type="checkbox" id="${id}" value="${s}" checked>
      <span>${s}</span>
    `;
    subtypeList.appendChild(row);
  }

  // Checkbox change → toggle presence
  subtypeList.addEventListener("change", (e)=>{
    const el = e.target;
    if (el && el.type === "checkbox") {
      const val = el.value;
      if (el.checked) activeSubtypes.add(val);
      else activeSubtypes.delete(val);
      draw();
    }
  });

  // Buttons
  document.getElementById("subtypeAll").addEventListener("click", ()=>{
    activeSubtypes = new Set(allSubtypes);
    for (const cb of subtypeList.querySelectorAll('input[type="checkbox"]')) cb.checked = true;
    draw();
  });
  document.getElementById("subtypeClear").addEventListener("click", ()=>{
    activeSubtypes = new Set();
    for (const cb of subtypeList.querySelectorAll('input[type="checkbox"]')) cb.checked = false;
    draw();
  });
}

/* Bubble size control */
function wireSizeControl(){
  sizeSlider.addEventListener("input", ()=>{
    sizeFactor = +sizeSlider.value;
    sizeVal.textContent = `${sizeFactor.toFixed(2)}×`;
    draw();
  });
  sizeReset.addEventListener("click", ()=>{
    sizeFactor=1.0; sizeSlider.value="1.0"; sizeVal.textContent="1.00×"; draw();
  });
}

/* Helpers */
function formatSig(v){
  if (!Number.isFinite(v)) return "–";
  const e = Math.log10(v);
  return (e >= -2 && e <= 3) ? v.toPrecision(3) : `1e${e.toFixed(1)}`;
}
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Superionic Conductors — Ea ≤ 0.6 · Ea vs σ (log Y)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
  :root { --bg:#ffffff; --panel:#f8f9fa; --grid:#dcdcdc; --text:#111; --panel-border:#cccccc; --note:#555; --accent:#007aff; }
  * { box-sizing:border-box; }
  body { margin:0; font-family:system-ui, Segoe UI, Roboto, sans-serif; background:var(--bg); color:var(--text); }

  header {
    display:flex; flex-wrap:wrap; gap:10px; align-items:center;
    padding:8px 12px; background:var(--panel); border-bottom:1px solid var(--panel-border);
    position:sticky; top:0; z-index:10;
  }
  label { display:flex; align-items:center; gap:6px; font-size:12px; }
  .slider-container { display:flex; align-items:center; gap:6px; font-size:12px; }
  input[type="range"] { width:160px; }
  .badge { font-size:11px; color:var(--note); margin-left:auto; }

  .wrap { display:grid; grid-template-columns: 1fr 280px; gap:10px; padding:10px; }
  #chart { width:100%; height:90vh; border:1px solid var(--grid); border-radius:8px; background:#fff; }

  aside {
    background:var(--panel); border:1px solid var(--panel-border);
    border-radius:8px; padding:10px; font-size:12px;
  }
  aside h3 { margin:0 0 8px 0; font-size:13px; color:#000; }

  #structureLegend .row{
    display:flex; align-items:center; gap:8px;
    padding:6px 8px; margin:5px 0; border-radius:8px;
    background:#fff; border:1px solid #ddd; cursor:pointer; user-select:none;
  }
  #structureLegend .row.active{ outline:2px solid var(--accent); }
  #structureLegend .swatch{ width:12px; height:12px; border-radius:3px; border:1px solid #0002; }
  #structureLegend .name{ color:#000; font-size:12px; }
  #structureLegend .count{ margin-left:auto; color:#555; font-size:11px; }

  #error { display:none; margin:8px 12px; padding:8px 12px; background:#fff3f3; color:#7f1d1d; border:1px solid #f5c2c2; border-radius:8px; white-space:pre-wrap; }
</style>
</head>
<body>
  <header>
    <div class="slider-container">
      <label for="sizeScale">Marker size:</label>
      <input type="range" id="sizeScale" min="6" max="36" value="16" step="1">
      <span id="scaleVal">16 px</span>
    </div>
    <span class="badge" id="status">Loading data.csv…</span>
  </header>

  <div id="error"></div>

  <div class="wrap">
    <div id="chart"></div>
    <aside>
      <h3>Structure Group (color) — click to filter</h3>
      <div id="structureLegend"></div>
    </aside>
  </div>

<script>
/* ---------- Status & error ---------- */
const statusEl = document.getElementById("status");
const errorEl  = document.getElementById("error");
function say(msg){ statusEl.textContent = msg; }
function err(msg){ errorEl.style.display='block'; errorEl.textContent = msg; console.error(msg); }

/* ---------- Your Structure Color Palette ---------- */
const structColors = {
  "Others":"#9e9e9e",
  "Polymeric":"#ff7043",
  "Argyrodite":"#ab47bc",
  "Halide":"#26a69a",
  "Amorphous":"#f6bf26",
  "NASICON":"#66bb6a",
  "Anti-perovskite":"#0d47a1",
  "Spinel":"#8d6e63"
};

/* Marker symbols for Ion Types */
const SHAPE_PALETTE = [
  "circle","square","diamond","triangle-up","triangle-down",
  "triangle-left","triangle-right","cross","x","star","hexagon"
];

/* Columns */
const COLS = {
  ion: "Ion Type",
  structGrouped: "Structure Group",
  ea: "Activation Energy Ea (eV)",
  sigma: "Conductivity σ (S/cm)",
  formula: "Superionic Conductor Formula (Chemical)"
};

let rowsGlobal = [];
let traceMeta = [];
let activeStructGroup = null;
let activeIon = null;
let markerSizePx = 16;
let ionSymbolMap = {};
let legendStubIndexByIon = {};

function toNum(v){
  if (typeof v === "number") return v;
  if (v == null) return NaN;
  const s = String(v).trim();
  if (!s || s.toLowerCase()==="na" || s.toLowerCase()==="n/a") return NaN;
  const n = Number(s.replace(/,/g,""));
  return Number.isFinite(n) ? n : NaN;
}

/* Build data traces: colored by structure only */
function buildDataTraces(filteredRows){
  const traces=[]; traceMeta=[];
  filteredRows.forEach(r=>{
    const ion = (r[COLS.ion]||"Other").trim();
    const fam = (r[COLS.structGrouped]||"Others").trim();
    const ea  = toNum(r[COLS.ea]);
    const sig = toNum(r[COLS.sigma]);
    const color = structColors[fam] || "#999";
    const symbol = ionSymbolMap[ion] || "circle";
    traces.push({
      x:[ea], y:[sig], mode:"markers",
      name: ion, legendgroup: ion, showlegend:false,
      marker:{
        size:[markerSizePx],
        color: color,
        symbol: symbol,
        line:{ width:1.0, color:"#000" },
        opacity:0.9
      },
      text:[`${r[COLS.formula]}<br>Ion: ${ion}<br>Structure: ${fam}`],
      hovertemplate:"<b>%{text}</b><br> Ea: %{x:.3f} eV<br> σ: %{y:.3e} S/cm<extra></extra>",
      visible:true
    });
    traceMeta.push({ion,fam});
  });
  return traces;
}

/* Ion Legend (neutral gray, shape only) */
function buildIonLegendTraces(ions){
  const neutral="#555";
  return ions.map(ion=>({
    x:[NaN], y:[NaN], mode:"markers",
    name:ion, legendgroup:ion, showlegend:true,
    marker:{
      size:[markerSizePx],
      color:neutral,
      symbol:ionSymbolMap[ion]||"circle",
      line:{width:1.5,color:"#000"},
      opacity:1
    },
    hoverinfo:"skip",
    visible:true
  }));
}

/* Structure Sidebar Legend */
function renderStructureLegend(filteredRows){
  const el=document.getElementById("structureLegend");
  if(!el)return; el.innerHTML="";
  const counts={};
  filteredRows.forEach(r=>{
    const g=(r[COLS.structGrouped]||"Others").trim();
    counts[g]=(counts[g]||0)+1;
  });
  Object.keys(counts).forEach(g=>{
    const row=document.createElement("div");
    row.className="row"; row.dataset.group=g;
    const sw=document.createElement("div");
    sw.className="swatch"; sw.style.background=structColors[g]||"#999";
    const name=document.createElement("div");
    name.className="name"; name.textContent=g;
    const count=document.createElement("div");
    count.className="count"; count.textContent=counts[g];
    row.append(sw,name,count);
    row.onclick=()=>{
      activeStructGroup=(activeStructGroup===g)?null:g;
      activeIon=null;
      Array.from(el.children).forEach(ch=>ch.classList.toggle("active",ch.dataset.group===(activeStructGroup||"")));
      applyFilters();
    };
    el.appendChild(row);
  });
}

function applyFilters(){
  if(!traceMeta.length)return;
  const nData=traceMeta.length;
  const showAll=!activeStructGroup&&!activeIon;
  const visData=traceMeta.map(meta=>{
    if(showAll)return true;
    if(activeIon)return meta.ion===activeIon;
    if(activeStructGroup)return meta.fam===activeStructGroup;
    return true;
  });
  const dataIdx=Array.from({length:nData},(_,i)=>i);
  Plotly.restyle("chart",{visible:visData.map(v=>v?true:"legendonly")},dataIdx);
}

function draw(){
  const filtered=rowsGlobal.filter(r=>{
    const ea=toNum(r[COLS.ea]); const s=toNum(r[COLS.sigma]);
    return Number.isFinite(ea)&&ea<=0.6&&Number.isFinite(s)&&s>0;
  });
  say(`Rows: ${rowsGlobal.length} · Plotted: ${filtered.length}`);
  const dataTraces=buildDataTraces(filtered);
  renderStructureLegend(filtered);
  const ions=[...new Set(filtered.map(r=>(r[COLS.ion]||"Other").trim()))];
  const ionLegend=buildIonLegendTraces(ions);
  const traces=[...dataTraces,...ionLegend];
  Plotly.newPlot("chart",traces,{
    paper_bgcolor:"#fff", plot_bgcolor:"#fff",
    xaxis:{title:"Activation Energy Ea (eV)",range:[0.05,0.6],gridcolor:"#e9e9e9"},
    yaxis:{title:"Conductivity σ (S/cm)",type:"log",gridcolor:"#e9e9e9"},
    legend:{
      title:{text:"Ion Type (shape)",font:{size:11,color:"#111"}},
      font:{size:10,color:"#111"},
      orientation:"h",x:0.5,xanchor:"center",y:1.08,
      itemclick:"toggle",groupclick:"togglegroup",
      bgcolor:"#fff",bordercolor:"#ddd",borderwidth:0.5
    },
    margin:{t:54,r:20,b:54,l:64}
  },{responsive:true,displaylogo:false});
}

function loadCsv(){
  fetch("data.csv",{cache:"no-store"})
    .then(resp=>resp.text())
    .then(text=>{
      Papa.parse(text,{
        header:true,skipEmptyLines:true,
        complete:(res)=>{
          rowsGlobal=res.data;
          const ions=[...new Set(rowsGlobal.map(r=>(r[COLS.ion]||"Other").trim()))];
          ions.forEach((ion,i)=>ionSymbolMap[ion]=SHAPE_PALETTE[i%SHAPE_PALETTE.length]);
          draw();
        }
      });
    });
}

document.getElementById("sizeScale").addEventListener("input",e=>{
  markerSizePx=parseInt(e.target.value);
  document.getElementById("scaleVal").textContent=markerSizePx+" px";
  draw();
});
loadCsv();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Superionic Conductors — Ea vs σ (log Y) • Cycle Filter</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
  :root{
    --bg:#ffffff; --panel:#ffffff; --grid:#dcdcdc; --zero:#cccccc; --text:#111111; --muted:#6b7280;
    --chip-bg:#f6f7fb; --chip-br:#e2e8f0; --chip-on:#111111; --chip-off:#6b7280;
    --chip-active-bg:#e8eef7; --chip-active-br:#cdd8f0;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
  header{
    display:flex;flex-wrap:wrap;gap:10px;align-items:center;
    padding:10px 12px;border-bottom:1px solid var(--grid);position:sticky;top:0;background:var(--panel);z-index:10;
  }
  .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .label{font-size:12px;color:var(--muted)}
  .chips{display:flex;flex-wrap:wrap;gap:6px}
  .btn{
    border:1px solid var(--chip-br);background:var(--chip-bg);color:var(--chip-off);
    border-radius:999px;padding:6px 10px;font-size:12px;cursor:pointer;user-select:none;
  }
  .btn.active{background:var(--chip-active-bg);color:var(--chip-on);border-color:var(--chip-active-br)}
  #chart{width:100vw;height:calc(100vh - 74px);}
  #status{margin-left:auto;font-size:12px;color:var(--muted)}
  .sep{width:1px;height:22px;background:var(--grid);margin:0 6px}
</style>
</head>
<body>
<header>
  <span class="label">Cycle range:</span>
  <div class="chips" id="cycleBar">
    <!-- chips injected by JS -->
  </div>

  <div class="sep"></div>

  <div class="row">
    <span class="label">X tick step:</span>
    <div class="chips" id="xTickBar">
      <button class="btn" data-step="0.10">0.10</button>
      <button class="btn active" data-step="0.05">0.05</button>
      <button class="btn" data-step="0.025">0.025</button>
    </div>
  </div>

  <div class="sep"></div>

  <div class="row">
    <label class="label"><input type="checkbox" id="clampX"> Clamp Ea to [0.05, 1.0]</label>
    <label class="label"><input type="checkbox" id="hiOut"> Highlight Ea &gt; 0.7 eV</label>
  </div>

  <div id="status">Loading data.csv…</div>
</header>

<div id="chart"></div>

<script>
/* ===========================
   Config & helpers
   =========================== */
const COLS = {
  ion:      ["Ion Type (Normalized)","Ion Type","Ion"],
  struct:   ["Structure Group (Canonical)","Structure Family (Canonical)","Structure Group","Structure"],
  ea:       ["Activation Energy Ea (eV)","Activation Energy Ea (eV)  [smart parsed]","Activation Energy (eV)","Ea","Activation Energy Ea (eV) "],
  sigma:    ["Conductivity σ (S·cm⁻¹)","σ (S·cm⁻¹)","Conductivity (S·cm⁻¹)","Conductivity σ (S/cm) [numeric]"],
  cycles:   ["Cycle Life (raw)","Cycle Life","Cycle","Cycle Life (numeric)"]
};

function pick(row, keys){
  for (const k of keys){ if (k in row) return row[k]; }
  return undefined;
}

function toNum(v){
  if (typeof v === "number") return v;
  if (v == null) return NaN;
  const s = String(v).trim();
  if (!s) return NaN;
  const n = Number(s.replace(/,/g,''));
  if (Number.isFinite(n)) return n;
  const m = s.match(/([+\-]?\d*\.?\d+(?:[eE][+\-]?\d+)?)/);
  return m ? Number(m[1]) : NaN;
}

function parseCycles(raw){
  if (raw == null) return null;
  const s = String(raw);
  const m = s.match(/(\d[\d,]*)/);
  if (!m) return null;
  return Number(m[1].replace(/,/g,''));
}

/* ===========================
   Cycle buckets (more granular)
   =========================== */
const cycleBreaks = [0,100,500,1000,1500,2000,2500,3000,4000,5000,7500,10000]; // bounds
function bucketLabel(i){
  if (i === "ALL") return "All";
  if (i === "NA") return "N/A";
  if (i === "GT") return "> 10000";
  const a = cycleBreaks[i], b = cycleBreaks[i+1];
  if (a === 0) return "0–100";
  return `${a+1}–${b}`;
}
function bucketCode(i){
  if (i === "ALL" || i === "NA" || i === "GT") return i;
  return `B${i}`; // B0, B1, ...
}
function cycleToBucketCode(cycles){
  const n = parseCycles(cycles);
  if (n == null || !Number.isFinite(n)) return "NA";
  for (let i=0; i<cycleBreaks.length-1; i++){
    const a = cycleBreaks[i], b = cycleBreaks[i+1];
    if ((i===0 && n>=a && n<=b) || (i>0 && n>a && n<=b)) return bucketCode(i);
  }
  return "GT";
}

/* Build chips */
const cycleBar = document.getElementById("cycleBar");
const chipDefs = ["ALL","NA", ...Array.from({length:cycleBreaks.length-1}, (_,i)=>i), "GT"];
chipDefs.forEach(def=>{
  const btn = document.createElement("button");
  btn.className = "btn" + (def==="ALL" ? " active" : "");
  btn.dataset.range = def;
  btn.textContent = bucketLabel(def);
  cycleBar.appendChild(btn);
});

/* ===========================
   Plot styling
   =========================== */
const structColors = {
  "Antiperovskite":"#e15759", "Perovskite":"#f28e2b", "Garnet":"#59a14f",
  "LISICON":"#4e79a7", "NASICON":"#76b7b2", "Argyrodite":"#af7aa1",
  "Halide":"#edc949", "Sulfide":"#ff9da7", "Closo-carbaborate":"#9c755f",
  "Nitride":"#b07aa1", "Phosphate":"#86bc86", "Silicide":"#a0cbe8",
  "Polymer":"#8cd17d", "Polymer composite":"#8cd17d", "Glass":"#c8d6f0",
  "Glass-Ceramic":"#c3b1e1", "Rock-Salt":"#e0b1b1", "Other / Novel":"#9e9e9e"
};

function symbolByIon(ion){
  const symbols = ["circle","square","diamond","cross","x","triangle-up","triangle-down","triangle-left","triangle-right","star"];
  let h = 0; for (let i=0;i<ion.length;i++) h = (h*31 + ion.charCodeAt(i)) >>> 0;
  return symbols[h % symbols.length];
}

let X_DTICK = 0.05;   // dense x tick
let X_TICK0 = 0.10;
let DEFAULT_XR = [0,2];
const statusEl = document.getElementById('status');
function say(t){ statusEl.textContent = t; }

/* jitter */
function hashToUnit(str){ let h=0; for(let i=0;i<str.length;i++){ h=((h<<5)-h)+str.charCodeAt(i); h|=0; } return (Math.abs(h)%100000)/100000; }
let JX = 0.02;      // eV
let JY_FRAC = 0.08; // fraction
function jitteredEa(ea, key){ const u=hashToUnit(key+"|x"); return ea + (u-0.5)*2*JX; }
function jitteredSigma(sig, key){ const u=hashToUnit(key+"|y"); return sig * (1 + (u-0.5)*2*JY_FRAC); }
function xRangeAuto(xs){ if(!xs.length) return [0.05,0.8]; const min=Math.min(...xs), max=Math.max(...xs); if(!isFinite(min)||!isFinite(max)||min===max) return [0.05,0.8]; const pad=Math.max(0.02,(max-min)*0.10); return [Math.max(0,min-pad), max+pad]; }

/* ===========================
   Data & build
   =========================== */
let RAW = [];
let ACTIVE_BUCKET = "ALL";

function buildTraces(rangeCode){
  // Group points by Ion trace; include only those in selected cycle bucket
  const byIon = new Map();
  let xs = [];

  for (const r of RAW){
    const ion = (pick(r, COLS.ion) || "Other").toString().trim() || "Other";
    const fam = (pick(r, COLS.struct) || "Other / Novel").toString().trim() || "Other / Novel";
    const Ea  = toNum(pick(r, COLS.ea));
    const sig = toNum(pick(r, COLS.sigma));
    const cycRaw = pick(r, COLS.cycles);

    if (!Number.isFinite(Ea) || !Number.isFinite(sig) || Ea > 0.8 || sig <= 0) continue;

    // filter by cycle bucket (ALL passes, else must match)
    const bc = cycleToBucketCode(cycRaw);
    if (rangeCode !== "ALL" && bc !== rangeCode) continue;

    if (!byIon.has(ion)){
      byIon.set(ion, {
        x:[], y:[], text:[], customdata:[],
        mode:"markers", type:"scattergl",
        name: ion, hovertemplate:
          "<b>%{text}</b><br>" +
          "Ea: %{x:.3f} eV<br>" +
          "σ: %{customdata:.3e} S·cm⁻¹<extra>"+ion+"</extra>",
        marker:{
          size: 12,
          symbol: symbolByIon(ion),
          line:{width:0.6, color:"#888"},
          opacity:0.88
        }
      });
    }
    const key = `${ion}|${fam}|${r["superionic conductor Formula (Chemical)"]||r["Formula"]||""}`;
    const tr = byIon.get(ion);
    const e = jitteredEa(Ea, key);
    const s = jitteredSigma(sig, key);

    tr.x.push(e);
    tr.y.push(s);
    tr.customdata.push(sig);
    tr.text.push(`${fam} · ${cycRaw ? (parseCycles(cycRaw)) : "N/A"}`);

    xs.push(e);
  }

  // update default x-range
  if (xs.length){
    DEFAULT_XR = document.getElementById("clampX").checked ? [0.05,1.0] : xRangeAuto(xs);
  }
  return Array.from(byIon.values());
}

function layout(){
  return {
    paper_bgcolor:"#ffffff", plot_bgcolor:"#ffffff", font:{color:"#111111"},
    xaxis:{
      title:"Activation Energy Ea (eV)",
      tickmode:"linear", tick0:X_TICK0, dtick:X_DTICK,
      range: DEFAULT_XR,
      gridcolor:"#dcdcdc", zerolinecolor:"#cccccc",
      titlefont:{size:12}, tickfont:{size:10}
    },
    yaxis:{
      title:"Conductivity σ (S·cm⁻¹)", type:"log",
      tickvals:[
        1e-8,2e-8,5e-8, 1e-7,2e-7,5e-7, 1e-6,2e-6,5e-6,
        1e-5,2e-5,5e-5, 1e-4,2e-4,5e-4, 1e-3,2e-3,5e-3,
        1e-2,2e-2,5e-2, 1e-1,2e-1,5e-1, 1,2,5,10,20,50,100
      ],
      ticktext:[
        "1e−8","2e−8","5e−8","1e−7","2e−7","5e−7","1e−6","2e−6","5e−6",
        "1e−5","2e−5","5e−5","1e−4","2e−4","5e−4","1e−3","2e−3","5e−3",
        "1e−2","2e−2","5e−2","1e−1","2e−1","5e−1","1","2","5","10","20","50","100"
      ],
      gridcolor:"#dcdcdc", zerolinecolor:"#cccccc",
      titlefont:{size:12}, tickfont:{size:10}
    },
    legend:{
      title:{text:"Ion (shape)", font:{size:11, color:"#111111"}},
      font:{size:10, color:"#111111"},
      itemclick:"toggleothers", itemdoubleclick:"toggle"
    },
    margin:{t:26, r:16, b:56, l:64}
  };
}

/* ===========================
   Render & events
   =========================== */
function render(){
  const data = buildTraces(ACTIVE_BUCKET);
  Plotly.react("chart", data, layout(), {responsive:true, displaylogo:false, modeBarButtonsToRemove:["select2d","lasso2d"]});
  const shown = data.reduce((s,t)=> s + (t.x?.length||0), 0);
  say(`Rows: ${RAW.length} • Showing: ${shown} • Cycle: ${bucketLabel(ACTIVE_BUCKET)}`);
}

document.getElementById("cycleBar").addEventListener("click", (e)=>{
  const b = e.target.closest("button.btn"); if(!b) return;
  document.querySelectorAll("#cycleBar .btn").forEach(x=>x.classList.remove("active"));
  b.classList.add("active");
  ACTIVE_BUCKET = b.dataset.range;
  render(); // rebuild traces per-ion with only points inside the bucket
});

document.getElementById("xTickBar").addEventListener("click", (e)=>{
  const b = e.target.closest("button.btn"); if(!b) return;
  document.querySelectorAll("#xTickBar .btn").forEach(x=>x.classList.remove("active"));
  b.classList.add("active");
  const step = parseFloat(b.getAttribute("data-step"));
  X_DTICK = step;
  X_TICK0 = 0.10; // keep aligned to 0.10 baseline
  render();
});

document.getElementById("clampX").addEventListener("change", render);
document.getElementById("hiOut").addEventListener("change", ()=>{
  // optional: emphasize high Ea by thicker outlines
  const on = document.getElementById("hiOut").checked;
  const gd = document.getElementById("chart");
  if (!gd || !gd.data) { render(); return; }
  const lineW = on ? 2 : 0.6;
  Plotly.restyle("chart", {"marker.line.width": lineW});
});

/* ===========================
   Load CSV
   =========================== */
function loadCSV(){
  fetch("data.csv", {cache:"no-store"})
    .then(r=>{
      if(!r.ok) throw new Error(`HTTP ${r.status} ${r.statusText}`);
      return r.text();
    })
    .then(txt=>{
      Papa.parse(txt, {
        header:true, skipEmptyLines:true,
        complete:(res)=>{
          RAW = res.data || [];
          say(`Loaded data.csv • rows: ${RAW.length}`);
          render();
        },
        error:(err)=>{ say("Parse error: " + err.message); }
      });
    })
    .catch(err=>{ say("Failed to load data.csv ("+err.message+")"); });
}

loadCSV();

/* Resize */
window.addEventListener("resize", ()=> Plotly.Plots.resize("chart"));
</script>
</body>
</html>

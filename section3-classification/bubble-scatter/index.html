<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Superionic Conductors — Ea ≤ 0.6 · Ea vs σ (log Y)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
  :root {
    --bg:#ffffff; --panel:#f8f9fa; --grid:#dcdcdc; --text:#111;
    --panel-border:#cccccc; --note:#555; --accent:#007aff;
  }
  * { box-sizing:border-box; }
  body { margin:0; font-family:system-ui,Segoe UI,Roboto,sans-serif; background:var(--bg); color:var(--text); }

  header {
    display:flex; flex-wrap:wrap; gap:10px; align-items:center;
    padding:8px 12px; background:var(--panel); border-bottom:1px solid var(--panel-border);
    position:sticky; top:0; z-index:10;
  }
  label { display:flex; align-items:center; gap:6px; font-size:12px; }
  input[type="checkbox"] { transform:translateY(1px); }
  .slider-container { display:flex; align-items:center; gap:6px; font-size:12px; }
  input[type="range"] { width:160px; }
  .badge { font-size:11px; color:var(--note); margin-left:auto; }

  .wrap { display:grid; grid-template-columns: 1fr 280px; gap:10px; padding:10px; }
  #chart { width:100%; height:90vh; border:1px solid var(--grid); border-radius:8px; background:#fff; }

  aside {
    background:var(--panel); border:1px solid var(--panel-border);
    border-radius:8px; padding:10px; font-size:12px;
  }
  aside h3 { margin:0 0 8px 0; font-size:13px; color:#000; }

  /* Right legend (Structure Groups) */
  #structureLegend .row{
    display:flex; align-items:center; gap:8px;
    padding:6px 8px; margin:5px 0; border-radius:8px;
    background:#fff; border:1px solid #ddd; cursor:pointer;
  }
  #structureLegend .row.active{ outline:2px solid var(--accent); }
  #structureLegend .swatch{ width:12px; height:12px; border-radius:3px; border:1px solid #0002; }
  #structureLegend .name{ color:#000; font-size:12px; }
  #structureLegend .count{ margin-left:auto; color:#555; font-size:11px; }

  /* Error banner */
  #error { display:none; margin:8px 12px; padding:8px 12px; background:#fff3f3; color:#7f1d1d; border:1px solid #f5c2c2; border-radius:8px; white-space:pre-wrap; }
</style>
</head>
<body>
  <header>
    <label><input type="checkbox" id="hiOut" /> Highlight Ea &gt; 0.5 eV</label>
    <div class="slider-container" title="Marker size scale">
      <label for="sizeScale">Size:</label>
      <input type="range" id="sizeScale" min="0.5" max="5" value="1.2" step="0.1">
      <span id="scaleVal">1.2×</span>
    </div>
    <div class="slider-container" title="Spread horizontally (Ea)">
      <label for="jx">X spread:</label>
      <input type="range" id="jx" min="0" max="0.05" value="0.02" step="0.001">
      <span id="jxVal">0.020 eV</span>
    </div>
    <div class="slider-container" title="Spread vertically (σ, % of value)">
      <label for="jy">Y spread:</label>
      <input type="range" id="jy" min="0" max="15" value="8" step="0.5">
      <span id="jyVal">8%</span>
    </div>
    <span class="badge" id="status">Loading data.csv…</span>
  </header>

  <div id="error"></div>

  <div class="wrap">
    <div id="chart"></div>
    <aside>
      <h3>Structure Group (color) — click to filter</h3>
      <div id="structureLegend"></div>
    </aside>
  </div>

<script>
/* ---------------- Status & error helpers ---------------- */
const statusEl = document.getElementById("status");
const errorEl  = document.getElementById("error");
function say(msg){ statusEl.textContent = msg; }
function err(msg){ errorEl.style.display='block'; errorEl.textContent = msg; console.error(msg); }

/* ---------------- Encodings ---------------- */
const structColors = {
  "Amorphous":"#a6cee3", "Anti-perovskite":"#1f78b4", "Argyrodite":"#b2df8a",
  "Halide":"#33a02c", "NASICON":"#fb9a99", "Spinel":"#e31a1c",
  "Polymeric":"#fdbf6f", "Other":"#999999"
};
const ionSymbols = {
  "Li+":"circle","Na+":"square","K+":"diamond","Mg2+":"triangle-up",
  "Ca2+":"triangle-down","H+":"x","Ag+":"star","Zn2+":"cross","Other":"circle-open"
};

/* ---------------- Fixed column names (no guessing) ---------------- */
const COLS = {
  ion: "Ion Type (Normalized)",
  structGrouped: "Structure Group (Canonical)",   // <-- exact column you specified
  ea: "Activation Energy Ea (eV)",
  sigma: "Conductivity σ (S·cm⁻¹)",
  formula: "superionic conductor Formula (Chemical)"
};
function toNum(v){
  if(typeof v==="number") return v;
  if(v==null) return NaN;
  const s=String(v).trim();
  if(!s || s.toLowerCase()==="na" || s.toLowerCase()==="n/a" || s==="—" || s==="–") return NaN;
  const n=Number(s.replace(/,/g,""));
  return Number.isFinite(n) ? n : NaN;
}

/* ---------------- Marker sizing & jitter ---------------- */
let sizeScaleFactor=1.2;
const BASE_MARKER_SIZE = 14;
function fixedMarkerSize(){ return BASE_MARKER_SIZE * sizeScaleFactor; }

function hashToUnit(str){ let h=0; for(let i=0;i<str.length;i++){ h=((h<<5)-h)+str.charCodeAt(i); h|=0; } return (Math.abs(h)%100000)/100000; }
let JX = 0.02;      // eV jitter
let JY_FRAC = 0.08; // % jitter in σ
function jitteredEa(ea, key){ const u=hashToUnit(key+"|x"); return ea + (u-0.5)*2*JX; }
function jitteredSigma(sig, key){ const u=hashToUnit(key+"|y"); return sig * (1 + (u-0.5)*2*JY_FRAC); }

/* ---------------- State ---------------- */
let last = null;                  // { rows }
let traceMeta = [];               // per-trace meta: {ion, famGrouped}
let activeStructGroup = null;     // right-legend filter

/* ---------------- Build traces (one per row) ---------------- */
function buildTraces(rows, hiOut){
  const traces=[], ionsSeen=new Set(); traceMeta=[];

  let stats = { total:0, kept:0, droppedEa:0, droppedSigma:0 };

  rows.forEach(r=>{
    stats.total++;
    const ea_raw = toNum(r[COLS.ea]);
    if(!Number.isFinite(ea_raw) || ea_raw > 0.6){ stats.droppedEa++; return; }   // **drop Ea > 0.6**

    const sigma_raw = toNum(r[COLS.sigma]);
    if(!Number.isFinite(sigma_raw) || sigma_raw <= 0){ stats.droppedSigma++; return; }

    const ion = (r[COLS.ion]||"Other").toString().trim() || "Other";
    const famGrouped = (r[COLS.structGrouped] || "Other").toString().trim() || "Other";
    const famColor = structColors[famGrouped] || structColors["Other"];

    const key = `${ion}|${famGrouped}|${r[COLS.formula]||""}`;
    const ea = jitteredEa(ea_raw, key);
    const sig = jitteredSigma(sigma_raw, key);

    stats.kept++;

    traces.push({
      x:[ea], y:[sig], customdata:[sigma_raw], mode:"markers",
      name: ion, legendgroup: ion, showlegend: !ionsSeen.has(ion),
      marker:{
        size:[fixedMarkerSize()],
        color: famColor,
        symbol: ionSymbols[ion] || ionSymbols["Other"],
        line:{ width: (hiOut && ea_raw>0.5) ? 2 : 0.7, color:(hiOut && ea_raw>0.5) ? "#ff4d4d" : "#222" },
        opacity: 0.9
      },
      text:[`${r[COLS.formula]||"(formula)"}<br>Ion: ${ion}<br>Structure: ${famGrouped}`],
      hovertemplate:"<b>%{text}</b><br> Ea: %{x:.3f} eV (jittered)<br> σ: %{customdata:.3e} S/cm<extra></extra>",
      visible: true
    });

    traceMeta.push({ ion, famGrouped });
    ionsSeen.add(ion);
  });

  return { data: traces, stats };
}

/* ---------------- Right legend (Structure Groups) ---------------- */
function renderStructureLegend(rows){
  const el = document.getElementById("structureLegend");
  if(!el) return;
  el.innerHTML = "";

  // Count per CSV grouped family **after** Ea filter
  const counts = {};
  rows.forEach(r=>{
    const ea_raw = toNum(r[COLS.ea]);
    if(!Number.isFinite(ea_raw) || ea_raw > 0.6) return;
    const g = (r[COLS.structGrouped] || "Other").toString().trim() || "Other";
    counts[g] = (counts[g] || 0) + 1;
  });

  // Order: known groups first if present, then extras alphabetically
  const KNOWN = ["Amorphous","Anti-perovskite","Argyrodite","Halide","NASICON","Spinel","Polymeric","Other"];
  const present = Object.keys(counts);
  const order = [...KNOWN.filter(x=>present.includes(x)), ...present.filter(x=>!KNOWN.includes(x)).sort()];

  order.forEach(g=>{
    const row = document.createElement("div");
    row.className = "row";
    row.dataset.group = g;

    const sw = document.createElement("div");
    sw.className = "swatch";
    sw.style.background = structColors[g] || "#999";

    const name = document.createElement("div");
    name.className = "name";
    name.textContent = g;

    const count = document.createElement("div");
    count.className = "count";
    count.textContent = counts[g] || 0;

    row.append(sw, name, count);
    row.onclick = ()=>{
      activeStructGroup = (activeStructGroup === g) ? null : g;
      Array.from(el.children).forEach(ch=>ch.classList.toggle("active", ch.dataset.group === (activeStructGroup||"")));
      applyStructFilter();
    };
    el.appendChild(row);
  });
}

function applyStructFilter(){
  if(!traceMeta.length) return;
  const vis = traceMeta.map(meta=>{
    if(!activeStructGroup) return true;
    return meta.famGrouped === activeStructGroup;
  });
  Plotly.restyle("chart", { visible: vis.map(v => v ? true : "legendonly") });
}

/* ---------------- Draw ---------------- */
function draw(rows){
  const { data, stats } = buildTraces(rows, document.getElementById("hiOut").checked);

  say(`Rows: ${stats.total} · Plotted: ${stats.kept} · Dropped Ea: ${stats.droppedEa} · Dropped σ: ${stats.droppedSigma}`);

  renderStructureLegend(rows);

  Plotly.newPlot("chart", data, {
    paper_bgcolor:"#fff", plot_bgcolor:"#fff",
    xaxis:{
      title:"Activation Energy Ea (eV)",
      range:[0.05, 0.6],
      tickformat:".2f",
      tickmode:"linear",
      tick0:0.10,
      dtick:0.05,
      gridcolor:"#e9e9e9",
      zerolinecolor:"#e9e9e9",
      titlefont:{size:12},
      tickfont:{size:10}
    },
    yaxis:{
      title:"Conductivity σ (S·cm⁻¹)",
      type:"log",
      gridcolor:"#e9e9e9",
      zerolinecolor:"#e9e9e9",
      titlefont:{size:12},
      tickfont:{size:10}
    },
    legend:{
      title:{text:"Ion Type (shape)", font:{size:11, color:"#111"}},
      font:{size:10, color:"#111"},
      itemclick:"toggle",
      groupclick:"togglegroup"
    },
    margin:{t:34, r:20, b:54, l:64}
  }, {
    responsive:true, displaylogo:false, modeBarButtonsToRemove:["select2d","lasso2d"]
  }).then(()=>{
    // Hover fade QoL
    const gd = document.getElementById('chart');
    gd.on('plotly_hover', (ev)=>{
      const ntr = ev.points.map(p=>p.curveNumber);
      const vis = traceMeta.map((_, i)=> ntr.includes(i) ? {opacity:0.95} : {opacity:0.15});
      Plotly.restyle('chart', { 'marker.opacity': vis.map(v=>v.opacity) });
    });
    gd.on('plotly_unhover', ()=>{ Plotly.restyle('chart', { 'marker.opacity': traceMeta.map(()=>0.9) }); });
    applyStructFilter();
  });
}

/* ---------------- CSV load & parse ---------------- */
function parseCsvAndDraw(csvText){
  Papa.parse(csvText, {
    header:true, dynamicTyping:false, skipEmptyLines:true,
    complete:(res)=>{
      if(!res.data || !res.data.length){ say("Parsed data.csv but found no rows."); return; }
      // Validate required fixed columns
      const cols = res.meta.fields || [];
      const must = [COLS.ion, COLS.structGrouped, COLS.ea, COLS.sigma];
      const missing = must.filter(m => !cols.includes(m));
      if (missing.length){
        say("Missing required columns: " + missing.join(", "));
        return;
      }
      last = { rows: res.data };
      activeStructGroup = null;
      draw(res.data);
    },
    error:(e)=>{ err("Parse error: " + e.message); }
  });
}
function loadDataCsv(){
  fetch("data.csv", { cache:"no-store" })
    .then(resp => { if(!resp.ok) throw new Error(`HTTP ${resp.status} ${resp.statusText}`); return resp.text(); })
    .then(csvText => { say("data.csv loaded ✓"); parseCsvAndDraw(csvText); })
    .catch(e => {
      const onGitHubViewer = location.hostname === 'github.com';
      const hint = onGitHubViewer
        ? "You’re viewing this on github.com (scripts blocked). Publish via GitHub Pages or open via a local server."
        : "Ensure data.csv is in the same folder and the page is served via http(s).";
      err(`Could not load data.csv: ${e.message}\n\n${hint}`);
    });
}

/* ---------------- Controls ---------------- */
document.getElementById("hiOut").addEventListener("change", ()=>{ if(last) draw(last.rows); });
document.getElementById("sizeScale").addEventListener("input", ()=>{
  sizeScaleFactor = parseFloat(sizeScale.value); document.getElementById("scaleVal").textContent = sizeScaleFactor.toFixed(1)+"×";
  if(last) draw(last.rows);
});
document.getElementById("jx").addEventListener("input", ()=>{
  JX = parseFloat(jx.value)||0; document.getElementById("jxVal").textContent = JX.toFixed(3)+" eV"; if(last) draw(last.rows);
});
document.getElementById("jy").addEventListener("input", ()=>{
  JY_FRAC = (parseFloat(jy.value)||0)/100; document.getElementById("jyVal").textContent = (JY_FRAC*100).toFixed(1)+"%"; if(last) draw(last.rows);
});

/* ---------------- Kick off ---------------- */
loadDataCsv();
</script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Circle Packing — Ion Type + Count</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    html, body {
      height: 100%;
      margin: 0;
      background: #ffffff; /* pure white background */
      display: flex;       /* center the chart */
      justify-content: center;
      align-items: center;
      color: #222;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Ubuntu, Cantarell, "Noto Sans", Arial;
    }

    #chart {
      height: 90vh;
      width: 90vw;
    }

    text.struct-label {
      fill: #111;
      pointer-events: none;
      text-anchor: middle;
      dominant-baseline: middle;
      font-weight: 700;
    }

    text.leaf-label {
      fill: #111;
      pointer-events: none;
      text-anchor: middle;
      dominant-baseline: middle;
      font-weight: 500;
      opacity: .9;
    }

    .breadcrumb {
      position: fixed;
      top: 10px;
      left: 12px;
      background: rgba(0,0,0,0.05);
      backdrop-filter: blur(8px);
      border: 1px solid rgba(0,0,0,0.1);
      padding: 8px 10px;
      border-radius: 10px;
      font-size: 13px;
      z-index: 10;
      user-select: none;
    }

    .breadcrumb a { color:#3366cc; text-decoration:none; cursor:pointer; }
    .breadcrumb .sep { opacity:.6; margin:0 6px; }

    /* Legends styling */
    #legends {
      position: absolute;
      bottom: 100px;     /* closer to the main circle */
      right: 100px;
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      z-index: 20;
      font-size: 13px;
      background: rgba(255,255,255,0.95);
      border: 1px solid rgba(0,0,0,0.15);
      padding: 8px 12px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      transition: all 0.3s ease;
    }

    .legend-box h4 {
      margin: 0 0 6px 0;
      font-size: 13px;
      font-weight: 700;
    }

    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 4px;
    }

    .legend-color {
      width: 12px;
      height: 12px;
      border-radius: 3px;
      margin-right: 6px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <div class="breadcrumb" id="trail"></div>
  <div id="chart"></div>

  <!-- Legends -->
  <div id="legends">
    <div id="struct-legend" class="legend-box"></div>
    <div id="ion-legend" class="legend-box"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script>
  d3.csv("data.csv").then(raw => {
    raw = raw.filter(d => d["Structure Group"] && d["Ion Type"])
             .map(d => ({
               group: String(d["Structure Group"]).trim(),
               ion:   String(d["Ion Type"]).trim()
             }));

    // Build hierarchy
    const grouped = d3.group(raw, d => d.group);
    const rootData = {
      name: "All",
      children: Array.from(grouped, ([group, rows]) => ({
        name: group,
        children: Array.from(
          d3.rollup(rows, v => v.length, d => d.ion),
          ([ion, count]) => ({ name: ion, value: count })
        )
      }))
    };

    // Palettes
    const ION_COLORS = {
      "Li+":  "#ff5252","Na+":  "#81d4fa","K+":   "#004d40","Ag+":  "#f48fb1",
      "O2-":  "#6d4c41","Zn2+": "#c2185b","H+":   "#ffd54f","Rb+":  "#43a047",
      "F-":   "#ff8a65","Cu+":  "#5c6bc0","Mg2+": "#26c6da","In3+": "#c0ca33",
      "I-":   "#ec407a","Sn4+": "#7e57c2"
    };
    const STRUCT_COLORS = {
      "Others":"#9e9e9e","Polymeric":"#ff7043","Argyrodite":"#ab47bc","Halide":"#26a69a",
      "Amorphous":"#f6bf26","NASICON":"#66bb6a","Anti-perovskite":"#0d47a1","Spinel":"#8d6e63"
    };
    const getIonColor    = ion   => ION_COLORS[ion]      || "#ccc";
    const getStructColor = group => STRUCT_COLORS[group] || "#ccc";

    draw(rootData);

    function draw(data) {
      const size = Math.min(window.innerWidth, window.innerHeight);
      const pack = d3.pack().size([size, size]).padding(3);
      const root = pack(d3.hierarchy(data)
        .sum(d => d.value || 0)
        .sort((a,b) => (b.value||0) - (a.value||0)));

      let focus = root, view;

      const svg = d3.select("#chart").append("svg")
        .attr("viewBox", `${-size/2} ${-size/2} ${size} ${size}`)
        .attr("width","100%").attr("height","100%")
        .style("cursor","pointer");

      const g = svg.append("g");
      const nodes = root.descendants();

      // Circles
      const circles = g.selectAll("circle")
        .data(nodes)
        .join("circle")
          // Make main (outermost) circle white with dark border
          .attr("fill", d => d.depth === 0 ? "#ffffff"
            : (d.children ? getStructColor(d.data.name) : getIonColor(d.data.name)))
          .attr("stroke", d => d.depth === 0 ? "#000000" : "rgba(0,0,0,0.2)")
          .attr("stroke-width", d => d.depth === 0 ? 3 : (d.children ? 1 : 0.75))
          .style("pointer-events", d => d.depth === 0 ? "none" : null)
          .on("click", (event, d) => focus !== d ? (zoom(event, d), event.stopPropagation()) : null);

      // Structure labels
      const structLabels = g.selectAll("text.struct-label")
        .data(nodes.filter(d => d.children && d.depth > 0))
        .join("text")
          .attr("class","struct-label")
          .text(d => d.data.name);

      // Ion (leaf) labels with type + count
      const leafLabels = g.selectAll("text.leaf-label")
        .data(nodes.filter(d => !d.children && d.depth > 0))
        .join("text")
          .attr("class","leaf-label");

      svg.on("click", e => zoom(e, root));
      zoomTo([root.x, root.y, root.r*2]);
      updateTrail(root);

      function zoomTo(v) {
        const k = size / v[2];
        view = v;

        circles
          .attr("transform", d => `translate(${(d.x - v[0])*k},${(d.y - v[1])*k})`)
          .attr("r", d => d.r * k);

        structLabels
          .style("display", d => (d.parent === focus ? "inline" : "none"))
          .attr("transform", d => `translate(${(d.x - v[0])*k},${(d.y - v[1])*k - d.r*k*0.5})`)
          .style("font-size", d => `${Math.max(10, (d.r*k)/5)}px`)
          .text(d => d.data.name);

        leafLabels
          .attr("transform", d => `translate(${(d.x - v[0])*k},${(d.y - v[1])*k})`)
          .style("display", d => (d.r*k >= 8 ? "inline" : "none"))
          .style("font-size", d => `${Math.max(7, Math.min(12, (d.r*k)/3.8))}px`)
          .text(d => `${d.data.name} (${d.value})`);
      }

      function zoom(event, d){
        focus = d;
        const t = svg.transition().duration(650)
          .tween("zoom", () => {
            const i = d3.interpolateZoom(view, [focus.x, focus.y, focus.r*2]);
            return t => zoomTo(i(t));
          });
        updateTrail(d);
      }

      function updateTrail(d){
        const trail = document.getElementById('trail');
        const ancestors = d.ancestors().reverse().slice(1);
        trail.innerHTML = ancestors.length
          ? ancestors.map((a,i)=>
              i===ancestors.length-1
                ? `<strong>${a.data.name}</strong>`
                : `<a data-depth="${i}">${a.data.name}</a>`
            ).join('<span class="sep">›</span>')
          : "";
        [...trail.querySelectorAll('a')].forEach(a=>{
          a.addEventListener('click', ()=>{
            const depth = +a.getAttribute('data-depth');
            const target = ancestors[depth];
            if(target) zoom(null, target);
          });
        });
      }

      window.addEventListener('resize', ()=>{
        const s = Math.min(window.innerWidth, window.innerHeight);
        svg.attr("viewBox", `${-s/2} ${-s/2} ${s} ${s}`);
        zoomTo([focus.x, focus.y, focus.r*2]);
      });
    }

    // === Legends ===
    function renderLegends() {
      // Structure Group Legend
      const structLegend = d3.select("#struct-legend");
      structLegend.html("<h4>Structure Group</h4>");
      Object.entries(STRUCT_COLORS).forEach(([name, color]) => {
        structLegend.append("div")
          .attr("class", "legend-item")
          .html(`<div class="legend-color" style="background:${color}"></div>${name}`);
      });

      // Ion Type Legend
      const ionLegend = d3.select("#ion-legend");
      ionLegend.html("<h4>Ion Type</h4>");
      Object.entries(ION_COLORS).forEach(([name, color]) => {
        ionLegend.append("div")
          .attr("class", "legend-item")
          .html(`<div class="legend-color" style="background:${color}"></div>${name}`);
      });
    }

    renderLegends();
  }).catch(()=>{
    document.getElementById('trail').textContent =
      "⚠️ Failed to load data.csv — open via a local web server (python3 -m http.server)";
  });
  </script>
</body>
</html>
